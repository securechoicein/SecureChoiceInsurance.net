<!DOCTYPE html>
<html lang="en" id="docHtml">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Colorado Relief Options — Home &amp; Auto Insurance</title>
  <meta name="description" content="Colorado residents: explore flexible home &amp; auto insurance options designed to protect your budget and peace of mind. Bundle, save, and see if you qualify for custom rate relief or flexible payments." />

  <!-- ================= QUICK SETUP =================
  REQUIRED FILES IN SAME FOLDER:
  - index.html
  - hero-house.png
  - hero-auto.png
  - hero-business.png
  ================================================== -->

  <script>
    // === REQUIRED: paste your deployed Google Apps Script Web App URL here ===
    window.GAS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbw5WUyuqjP6HODx88cSVY2ga2jhl7g29fRaqJb7OXneFH96lM0TyEGZxZdQtnD0dbOf4A/exec";

    // Optional separate LLM endpoint (usually leave blank to reuse GAS)
    window.POLICYPRO_LLM_ENDPOINT = "";

    // ✅ Default: run PolicyPro in LOCAL mode (no API keys required)
    window.POLICYPRO_MODE = "local";

    // Tracking (optional)
    window.GA4_MEASUREMENT_ID = "";
    window.GOOGLE_ADS_ID = "";
    window.GOOGLE_ADS_CONVERSION_LABEL = "";
    window.META_PIXEL_ID = "";

    window.AGENT_EMAIL = "securechoicein@gmail.com";

    // === ClickFunnels (recommended for "Check My Options") ===
    window.CLICKFUNNEL_URL = "";
    
  // ===== Conditional reveal: Check My Options appears after interaction =====
  (function(){
    var cta = document.getElementById('openFunnel');
    if(!cta) return;

    function revealCTA(){
      cta.classList.add('visible');
      cta.removeAttribute('aria-hidden');
      window.removeEventListener('scroll', onScroll);
    }

    function onScroll(){
      if(window.scrollY > window.innerHeight * 0.25){
        revealCTA();
      }
    }

    window.addEventListener('scroll', onScroll, { passive:true });

    // Also reveal if Policy Health Check is started
    var phcBtn = document.getElementById('startPHC');
    if(phcBtn){
      phcBtn.addEventListener('click', revealCTA);
    }
  })();

</script>

  <!-- Preload hero images for smoother first paint (PNG only) -->
  <link rel="preload" as="image" href="hero-house.png">
  <link rel="preload" as="image" href="hero-auto.png">
  <link rel="preload" as="image" href="hero-business.png">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Playfair+Display:wght@500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --card:#0f172a;
      --line:rgba(148,196,255,.35);
      --brand:#38bdf8;
      --brand2:#0ea5e9;
      --ok:#22c55e;
      --warn:#facc15;

      /* Desktop hero fitting:
        - "contain" shows the full PNG (no cropping)
        - "cover" fills the hero (may crop)
      */
      --hero-fit-desktop: cover;
      --hero-bg-desktop: #000;
    }

    *{box-sizing:border-box}

    body{
      margin:0;
      font-family:Inter,system-ui,sans-serif;
      background:#0b1323;
      color:#e5e7eb;
      overflow-x:hidden;
    }

    /* HERO */
    .hero{
      position:relative;
      min-height:90vh;
      display:flex;
      align-items:center;
      justify-content:flex-start;
      padding:48px;
      overflow:hidden;
      isolation:isolate;
    }

    /* Make hero content readable + consistent across screen sizes */
    .hero-content{position:relative;max-width:680px;z-index:2;width:100%;}

    /* Dark overlay so text stays readable on photos */
    /* Dark overlay so text stays readable on photos — tuned for brightness */
    .hero::before{
      content:"";
      position:absolute;
      inset:0;
      /* Lighter, contrast-preserving overlay instead of heavy dark wash */
      background:linear-gradient(rgba(5,10,25,.55), rgba(5,10,25,.55));
      z-index:1;
      pointer-events:none;
    }

    /* Rotating background slides (mobile-safe): JS-driven crossfade */
    .hero-rotator{
      position:absolute;
      inset:0;
      height:100%;
      z-index:0;
      pointer-events:none;
      background:transparent;
    }

        .hero-slide{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
      object-position:50% 50%;
      opacity:0;
      /* Increase perceived sharpness + brightness */
      filter: brightness(1.08) contrast(1.12) saturate(1.12);
      image-rendering:auto;
      transition:opacity 900ms ease;
      will-change:opacity;
    }

    .hero-slide.active{ opacity:1; }

    /* Desktop: prefer showing full PNG without awkward cropping */
        /* Desktop: prefer showing full PNG without awkward cropping */
    @media (min-width: 901px){
      .hero{ min-height:100vh; padding:72px 72px; }
      .hero-content{ max-width:760px; }
      .hero-rotator{ background: var(--hero-bg-desktop); }
      .hero-slide{
        object-fit: var(--hero-fit-desktop);
        object-position: 50% 45%;
        transform:none;
        /* Extra desktop clarity (large screens can handle it) */
        filter: brightness(1.12) contrast(1.15) saturate(1.15);
      }
    }
  .hero-content{ max-width:760px; }
  .hero-rotator{ background: var(--hero-bg-desktop); }
  .hero-slide{
    object-fit: var(--hero-fit-desktop);
    object-position: 50% 50%;
    /* Remove scaling on desktop so images don't overflow */
    transform:none;
  }
}

/* Reduce motion for accessibility */
@media (prefers-reduced-motion: reduce){
  .hero-slide{ transition:none; }
}
    }

    .hero-content{position:relative;max-width:680px;z-index:2}
    .badge{display:inline-block;padding:6px 12px;border-radius:999px;background:rgba(56,189,248,.15);border:1px solid rgba(56,189,248,.4);font-size:12px;font-weight:700;color:#c7e9ff}

    /* Hero header (uses the same font as the PP mark) */
    .hero-headline{
      margin:0 0 18px;
      font-size:clamp(40px,6vw,72px);
      line-height:1.02;
      letter-spacing:.01em;
      color:#ffffff;
      font-family:'Playfair Display','Didot','Bodoni MT',serif;
      font-weight:700;
      text-shadow:0 18px 70px rgba(0,0,0,.55);
    }

    /* Primary CTA – ChannelTalk-style (white, PP font) */
    .hero-cta-wrap{display:flex;flex-direction:column;gap:10px;max-width:520px;}
    .cta{
      margin-top:24px;
      padding:14px 28px;
      font-size: 16px;
  line-height: 1.6;
  opacity: 0;
  transform: translateY(6px);
  animation: phcFadeIn 0.6s ease-out forwards;
  animation-delay: 0.4s;
      font-weight:700;
      border-radius:999px;
      border:1px solid #e5e7eb;
      cursor:pointer;
      background:#ffffff;
      color:#0b1120;
      font-family:'Playfair Display','Didot','Bodoni MT',serif;
      box-shadow:0 18px 55px rgba(0,0,0,.25);
      transition:transform .15s ease, box-shadow .15s ease, filter .15s ease;
    }
    .cta:hover{
      transform:translateY(-1px);
      box-shadow:0 22px 70px rgba(0,0,0,.28);
      filter:brightness(1.01);
    }
    .cta:active{transform:translateY(0);box-shadow:0 14px 40px rgba(0,0,0,.22);}

    /* Secondary CTA */
    /* Secondary CTA (Health Check) — add subtle gradient border so it doesn’t blend */
    .cta.cta-secondary{
      margin-top:0;
      background:rgba(255,255,255,.94);
      position:relative;
    }
    .cta.cta-secondary::before{
      content:"";
      position:absolute;
      inset:-1px;
      border-radius:999px;
      background:linear-gradient(90deg, rgba(56,189,248,.75), rgba(34,197,94,.55), rgba(56,189,248,.75));
      z-index:-1;
      filter:blur(.0px);
      opacity:.85;
    }
    .cta.cta-secondary:hover{ filter:brightness(1.03); }

    /* Policy Health Check hook (A/B + subtle attention draw) */
    /* Policy Health Check hook (HERO) — make it pop */
    /* Policy Health Check hook — match Channelview / ChannelTalk font */
    .phc-hook-hero{
      margin:0 0 10px;
      font-family: Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      font-size:16px;
      font-weight:600; /* ChannelTalk-style medium weight */
      line-height:1.45;
      letter-spacing:-0.01em;
      color:#ffffff;
      text-shadow:0 12px 36px rgba(0,0,0,.45);
      opacity:.98;
      padding:12px 14px 12px 14px;
      border-radius:16px;
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border:1px solid rgba(148,196,255,.35);
      box-shadow:0 18px 60px rgba(0,0,0,.26);
      position:relative;
      overflow:hidden;
    }
    .phc-hook-hero::before{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      background:radial-gradient(600px 180px at 18% 0%, rgba(56,189,248,.28), transparent 55%),
                 radial-gradient(420px 180px at 92% 10%, rgba(34,197,94,.14), transparent 60%);
      opacity:.95;
    }
    .phc-hook-hero
    .phc-hook-hero.attn{ animation:phcGlow 2.4s ease-in-out 1; }
    @keyframes phcGlow{
      0%{transform:translateY(0); filter:saturate(1);}
      45%{transform:translateY(-1px); filter:saturate(1.15);}
      70%{box-shadow:0 22px 80px rgba(56,189,248,.12), 0 18px 60px rgba(0,0,0,.26);}
      100%{transform:translateY(0);}
    }
    @keyframes phcGlow{
      0%{opacity:.85;}
      40%{opacity:1; text-shadow:0 0 0 rgba(56,189,248,0);}
      70%{text-shadow:0 0 28px rgba(56,189,248,.45);}
      100%{opacity:.96;}
    }

    /* Optional: gently guide users to start with the Health Check once per visitor */
    body.phc-gate #openFunnel{ opacity:.82; filter:saturate(.92) brightness(.98); transform:translateY(0); }
    body.phc-gate #ctaMicro{ opacity:.92; }
    body.phc-gate #openHealthCheck{ box-shadow:0 22px 80px rgba(56,189,248,.10), 0 18px 55px rgba(0,0,0,.25); }

    /* Microcopy under CTA */
    .cta-micro{
      font-size:12px;
      font-weight:800;
      color:rgba(226,232,240,.92);
      text-shadow:0 10px 30px rgba(0,0,0,.45);
      letter-spacing:.01em;
    }

    /* Mobile: make the primary CTA easier to tap and not oversized */
    @media (max-width: 900px){
      .hero-cta-wrap{max-width:520px;width:100%;}
      .cta{
        width:100%;
        max-width:520px;
        margin-top:10px;
        margin-bottom:0;
        padding:14px 18px;
        font-size:15px;
        min-height:50px;
      }
      .cta-micro{font-size:12px;opacity:.95;}
    }

    /* Alert */
    .alert-box{position:absolute;right:8%;bottom:12%;width:260px;background:rgba(15,23,42,.92);border-radius:14px;padding:14px;border:1px solid rgba(148,196,255,.55);box-shadow:0 20px 50px rgba(0,0,0,.6);z-index:2}
    .alert-title{font-size:11px;text-transform:uppercase;letter-spacing:.14em;color:#facc15;margin-bottom:6px}
    .alert-text{font-size:13px;color:#e5e7eb;line-height:1.35}

    /* Hide floating alert on smaller screens so it doesn't overlap CTA */
    @media (max-width: 1100px){
      .alert-box{display:none;}
    }

    /* ================== POLICY HEALTH CHECK ================== */

    .phc-wrap{
      max-width:960px;
      margin:32px auto 18px;
      padding:0 16px;
    }

    .phc-card{
      background:#ffffff;
      border-radius:20px;
      border:1px solid #e5e7eb;
      box-shadow:0 20px 60px rgba(2,6,23,.12);
      padding:22px 22px 18px;
    }

    .phc-header{
      display:flex;
      gap:14px;
      align-items:flex-start;
      margin-bottom:16px;
    }

    .phc-badge{
      flex:0 0 auto;
      width:36px;height:36px;
      border-radius:10px;
      display:flex;align-items:center;justify-content:center;
      background:#0ea5e9;
      color:#fff;
      font-weight:900;
    }

    .phc-title{
      font-size:18px;
      font-weight:900;
      color:#0b1120;
      margin:0;
    }

    .phc-hook{
      margin:6px 0 0;
      font-size:13px;
      line-height:1.4;
      color:#475569;
      font-weight:700;
    }

    .phc-steps{
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:12px;
    }

    .phc-step{
      border:1px solid #e5e7eb;
      border-radius:16px;
      padding:14px 14px 12px;
      background:#f8fafc;
    }

    .phc-step h4{
      margin:0 0 6px;
      font-size:13px;
      font-weight:900;
      color:#0b1120;
    }

    .phc-options{
      display:grid;
      gap:8px;
    }

    .phc-opt{
      border:1px solid #cbd5e1;
      background:#ffffff;
      border-radius:12px;
      padding:10px 12px;
      font-size:12.5px;
      font-weight:800;
      cursor:pointer;
      text-align:left;
    }

    .phc-opt.active{
      border-color:#0ea5e9;
      background:rgba(14,165,233,.08);
    }

    .phc-footer{
      margin-top:16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }

    .phc-progress{
      font-size:11px;
      color:#64748b;
      font-weight:800;
    }

    .phc-submit{
      padding:10px 18px;
      border-radius:999px;
      border:1px solid #0b1120;
      background:#0b1120;
      color:#ffffff;
      font-weight:900;
      font-size:13px;
      cursor:pointer;
    }

    /* ================== PHC RESULT (Green/Yellow/Red) ================== */
    .phc-result{
      display:none;
      margin-top:14px;
      border:1px solid #e5e7eb;
      border-radius:18px;
      padding:14px 14px 12px;
      background:#ffffff;
      box-shadow:0 14px 40px rgba(2,6,23,.06);
    }
    .phc-result.show{display:block;}

    .phc-result-top{display:flex;align-items:center;justify-content:space-between;gap:12px;}
    .phc-result-left{display:flex;align-items:center;gap:10px;}
    .phc-dot{width:12px;height:12px;border-radius:999px;background:#22c55e;box-shadow:0 0 0 6px rgba(34,197,94,.12);} /* green */
    .phc-dot.yellow{background:#facc15;box-shadow:0 0 0 6px rgba(250,204,21,.16);} /* yellow */
    .phc-dot.red{background:#ef4444;box-shadow:0 0 0 6px rgba(239,68,68,.14);} /* red */
    .phc-result-label{font-weight:1000;color:#0b1120;font-size:12px;letter-spacing:.08em;text-transform:uppercase;}

    .phc-result-copy{margin:10px 0 8px;color:#0b1120;font-weight:900;font-size:13px;line-height:1.35;}
    .phc-result-why{margin:0;padding-left:18px;display:grid;gap:6px;}
    .phc-result-why li{color:#475569;font-weight:800;font-size:12px;line-height:1.35;}

    /* Micro-summary (above CTA) */
    .phc-summary{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px dashed rgba(15,23,42,.18);
      background:rgba(248,250,252,.9);
      color:#0b1120;
      font-weight:900;
      font-size:12.5px;
      line-height:1.35;
    }

    .phc-result-actions{margin-top:12px;display:flex;gap:10px;align-items:center;justify-content:flex-end;flex-wrap:wrap;}
    .phc-run{border:1px solid #cbd5e1;background:#fff;color:#0b1120;font-weight:1000;}
    .phc-continue{border:1px solid #0b1120;background:#0b1120;color:#fff;font-weight:1000;}

    @media (max-width: 600px){
      .phc-result{border-radius:16px;}
      .phc-result-actions .btn{width:100%;}
    }

    /* Desktop tightening */
    @media (min-width: 1000px){
      .phc-wrap{ max-width:880px; }
      .phc-steps{ grid-template-columns:repeat(4,1fr); }
      .phc-card{ padding:20px 20px 16px; }
    }

    /* Tablet */
    @media (max-width: 999px){
      .phc-steps{ grid-template-columns:repeat(2,1fr); }
    }

    /* Mobile */
    @media (max-width: 560px){
      .phc-steps{ grid-template-columns:1fr; }
      .phc-card{ padding:18px 14px 14px; }
      .phc-title{ font-size:17px; }
    }

    /* ================== POLICY HEALTH CHECK (MOBILE TAP FLOW) ================== */
    .phc-mobile-flow{display:none;}

    .phc-q{
      border:1px solid #e5e7eb;
      border-radius:16px;
      padding:12px 12px 10px;
      background:#f8fafc;
    }
    .phc-q-title{margin:0 0 8px;font-weight:1000;color:#0b1120;font-size:13px;line-height:1.25;}
    .phc-q-hint{margin:0 0 10px;color:#64748b;font-weight:800;font-size:11.5px;line-height:1.35;}

    .phc-answers{display:grid;gap:10px;}
    .phc-answer-btn{
      width:100%;
      text-align:left;
      border:1px solid #cbd5e1;
      background:#ffffff;
      border-radius:14px;
      padding:12px 12px;
      font-weight:1000;
      color:#0b1120;
      cursor:pointer;
      box-shadow:0 10px 22px rgba(2,6,23,.05);
      -webkit-tap-highlight-color: transparent;
    }
    .phc-answer-btn:active{transform:translateY(1px)}
    .phc-answer-btn.active{
      border-color:#0ea5e9;
      background:rgba(14,165,233,.10);
      box-shadow:0 12px 26px rgba(2,6,23,.07);
    }

    .phc-mobile-nav{display:flex;gap:10px;margin-top:12px;}
    .phc-mobile-nav .btn{flex:1;}

    /* Checkbox chips highlight when tapped */
    .phc-chip.active{
      border-color:#0ea5e9 !important;
      background:rgba(14,165,233,.10) !important;
    }

    /* Mobile: turn PHC selects into tap-to-advance flow */
    @media (max-width: 600px){
      .phc-mobile-flow{display:block;}
      .phc-desktop-grid{display:none !important;}
      .phc-grid{gap:8px;}
      .phc-chip{width:100%;justify-content:flex-start;}
    }

/* ================== CHAT: Channel.io-like launcher ================== */
    .chat-launcher{
      position:fixed;
      right:20px;
      bottom:22px;
      z-index:26000;
      display:flex;
      align-items:center;
      gap:10px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }

    .chat-peek{
      display:flex;
      flex-direction:column;
      gap:2px;
      padding:10px 12px;
      border-radius:14px;
      background:#ffffff;
      border:1px solid #e5e7eb;
      backdrop-filter:blur(10px);
      box-shadow:0 18px 55px rgba(0,0,0,.25);
    }
    .chat-peek .chat-label{
      font-size:11px;
      opacity:.85;
      font-weight:700;
      color:#0b1120;
      letter-spacing:.01em;
      font-family:'Playfair Display','Didot','Bodoni MT',serif;
    }
    .chat-peek .chat-name{
      font-weight:700;
      font-size:13px;
      letter-spacing:.01em;
      color:#0b1120;
      font-family:'Playfair Display','Didot','Bodoni MT',serif;
    }

    .chat-bubble{
      width:56px;height:56px;
      border-radius:999px;
      display:flex;align-items:center;justify-content:center;
      background:#ffffff;
      border:1px solid #e5e7eb;
      box-shadow:0 22px 70px rgba(0,0,0,.25);
      position:relative;
      transition:transform .18s ease, filter .18s ease;
      animation: chatPulse 2.6s ease-in-out infinite;
    }
    .chat-bubble:hover{transform:translateY(-2px) scale(1.03);filter:brightness(1.06)}
    .chat-bubble:active{transform:translateY(0) scale(0.99)}

    .chat-avatar{
      width:44px;height:44px;
      border-radius:999px;
      display:flex;align-items:center;justify-content:center;
      font-family:'Playfair Display', 'Didot', 'Bodoni MT', serif;
      font-weight:600;
      font-size:22px;
      color:#020617;
      background:#ffffff;
    }

    @keyframes chatPulse{
      0%{ box-shadow:0 22px 70px rgba(0,0,0,.25), 0 0 0 0 rgba(2,6,23,.15); }
      50%{ box-shadow:0 22px 70px rgba(0,0,0,.25), 0 0 0 12px rgba(2,6,23,0); }
      100%{ box-shadow:0 22px 70px rgba(0,0,0,.25), 0 0 0 0 rgba(2,6,23,0); }
    }

    /* ================== CHAT WIDGET (ChannelTalk-like) ================== */
    .chat-window{
      display:none;
      position:fixed;
      right:20px;
      bottom:96px;
      width:360px;
      max-height:78vh;
      z-index:25000;
    }

    .pp-widget{
      width:100%;
      background:#fff;
      color:#0b1120;
      border-radius:22px;
      overflow:hidden;
      border:1px solid rgba(15,23,42,.10);
      box-shadow:0 40px 120px rgba(0,0,0,.42);
    }

    .pp-top{
      position:relative;
      height:150px;
      background:
        linear-gradient(180deg, rgba(2,6,23,0) 40%, rgba(2,6,23,.45) 100%),
        url('hero-house.png') center/cover no-repeat;
    }

    .pp-topbar{
      position:absolute;
      left:0; right:0; bottom:0;
      padding:14px 14px 12px;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
    }

    .pp-brand{
      color:#fff;
      font-weight:900;
      letter-spacing:.01em;
      font-size:18px;
      text-shadow:0 8px 30px rgba(0,0,0,.55);
    }

    .pp-body{padding:12px 14px 10px;background:#fff;}

    .pp-screen{ display:none; }
    .pp-screen.active{ display:block; }

    .pp-home-card{
      border:1px solid #eef2f7;
      border-radius:18px;
      padding:12px 12px;
      background:#fff;
      box-shadow:0 14px 40px rgba(2,6,23,.06);
    }

    .pp-home-row{display:flex;gap:10px;align-items:flex-start}
    .pp-avatar{
      width:38px;height:38px;border-radius:999px;
      display:flex;align-items:center;justify-content:center;
      border:1px solid #e5e7eb;
      background:#fff;
      font-family:'Playfair Display','Didot','Bodoni MT',serif;
      font-weight:700;
      color:#0b1120;
      flex:0 0 auto;
    }

    .pp-home-title{margin:0;font-weight:900;font-size:13.5px;line-height:1.25}
    .pp-home-sub{margin:6px 0 0;color:#475569;font-weight:700;font-size:12px;line-height:1.35}

    .pp-primary{
      width:100%;
      margin-top:12px;
      padding:12px 12px;
      border-radius:999px;
      border:1px solid #eef2f7;
      background:#f3f4f6;
      color:#0b1120;
      font-weight:900;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
    }
    .pp-primary:hover{filter:brightness(1.01)}

    .pp-footer-note{
      margin-top:10px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      color:#94a3b8;
      font-weight:800;
      font-size:11px;
    }

    .pp-messages-wrap{
      border:1px solid #eef2f7;
      border-radius:18px;
      overflow:hidden;
      background:#fff;
    }

    .chat-main{display:flex;flex-direction:column;height:360px;min-height:320px;}
    .chat-messages{padding:12px;overflow:auto;flex:1;background:#ffffff;}

    .msg{display:flex;margin:10px 0}
    .msg.user{justify-content:flex-end}
    .msg.bot{justify-content:flex-start}
    .bubble{max-width:86%;padding:10px 12px;border-radius:14px;font-size:13.5px;line-height:1.45;box-shadow:0 10px 26px rgba(0,0,0,.06)}
    .bubble.user{background:#0b1120;color:#e5e7eb;border-top-right-radius:6px}
    .bubble.bot{background:#ffffff;color:#0f172a;border:1px solid #e5e7eb;border-top-left-radius:6px}

    .chat-inputbar{padding:10px;border-top:1px solid #eef2f7;background:#fff;display:flex;gap:10px;align-items:center}
    .chat-input{flex:1;padding:12px 12px;border-radius:14px;border:1px solid #cbd5e1;font-size:14px;outline:none}
    .chat-input:focus{border-color:rgba(56,189,248,.9);box-shadow:0 0 0 4px rgba(56,189,248,.12)}
    .send-btn{padding:12px 14px;border-radius:14px;border:1px solid #0b1120;background:#0b1120;color:#e5e7eb;font-weight:1000;cursor:pointer}
    .send-btn:disabled{opacity:.55;cursor:not-allowed}

    /* Suggested question chips (ChannelTalk-like) */
    .pp-suggest-wrap{padding:14px 14px 10px;}
    .pp-suggest-title{font-weight:1000;font-size:12px;color:#0b1120;margin:0 0 12px;letter-spacing:.01em;text-align:left;}
    .pp-suggest-section{display:grid;gap:10px;margin-bottom:14px;}
    .pp-suggest-label{font-weight:1000;font-size:11px;color:#94a3b8;letter-spacing:.08em;}
    .pp-suggest-grid{display:flex;flex-wrap:wrap;gap:10px;}
    .pp-suggest-chip{
      border:1px solid #e2e8f0;
      background:#f8fafc;
      color:#0b1120;
      border-radius:16px;
      padding:12px 14px;
      font-weight:900;
      font-size:12.5px;
      cursor:pointer;
      line-height:1.25;
      box-shadow:0 12px 26px rgba(2,6,23,.06);
      transition:transform .12s ease, filter .12s ease, box-shadow .12s ease;
    }
    .pp-suggest-chip:hover{filter:brightness(1.01);transform:translateY(-1px)}
    .pp-suggest-chip:active{transform:translateY(0)}

    /* Policy Health Check chips */
    .phc-grid{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px;}
    .phc-chip{display:inline-flex;align-items:center;gap:10px;padding:12px 14px;border-radius:16px;border:1px solid #e2e8f0;background:#f8fafc;color:#0b1120;font-weight:900;font-size:12.5px;cursor:pointer;box-shadow:0 12px 26px rgba(2,6,23,.06);}
    .phc-chip input{transform:scale(1.05);}
    @media (max-width: 420px){.phc-chip{width:100%;justify-content:flex-start;}}

    @media (max-width: 420px){
      .pp-suggest-grid{gap:8px;}
      .pp-suggest-chip{width:100%;text-align:left;}
    }

    .pp-tabs{
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      border-top:1px solid #eef2f7;
      background:#fff;
      padding:8px 6px;
    }

    .pp-tab{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:6px;
      padding:8px 6px;
      border-radius:14px;
      border:0;
      background:transparent;
      cursor:pointer;
      color:#64748b;
      font-weight:900;
      font-size:11px;
    }

    .pp-tab svg{width:18px;height:18px;opacity:.75;transition:transform .15s ease, opacity .15s ease}

    /* Nicer Settings gear */
    .pp-tab#ppTabSettings svg{width:19px;height:19px;stroke-width:1.8;}
    .pp-tab#ppTabSettings:hover svg{opacity:.95;transform:rotate(20deg)}
    .pp-tab#ppTabSettings.active svg{opacity:1;transform:rotate(0deg)}

    .pp-tab.active{color:#0b1120;background:#f8fafc;}
    .pp-tab:hover{color:#0b1120;background:#f8fafc}

    .pp-close-fab{
      position:absolute;
      right:10px;
      bottom:-62px;
      width:48px;height:48px;
      border-radius:999px;
      border:1px solid #e5e7eb;
      background:#fff;
      color:#0b1120;
      box-shadow:0 18px 60px rgba(0,0,0,.25);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:20px;
      font-weight:900;
    }
    .pp-close-fab:hover{filter:brightness(1.02)}

    .pp-settings{
      border:1px solid #eef2f7;
      border-radius:18px;
      padding:12px 12px;
      background:#fff;
    }
    .pp-settings h3{margin:0 0 10px;font-size:13.5px;font-weight:1000;color:#0b1120}
    .pp-setting-item{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 10px;border:1px solid #eef2f7;border-radius:14px;background:#fff;margin-bottom:10px}
    .pp-select{
      appearance:none;
      -webkit-appearance:none;
      -moz-appearance:none;
      border:1px solid #e2e8f0;
      background:#f8fafc;
      color:#0b1120;
      font-weight:900;
      font-size:12px;
      border-radius:12px;
      padding:10px 34px 10px 12px;
      cursor:pointer;
      line-height:1;
      box-shadow:0 10px 22px rgba(2,6,23,.05);
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='%23647569' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat:no-repeat;
      background-position:right 10px center;
      background-size:18px 18px;
    }
    .pp-select:focus{outline:none;border-color:rgba(56,189,248,.9);box-shadow:0 0 0 4px rgba(56,189,248,.12)}
    .pp-select:hover{filter:brightness(1.01)}
    .pp-setting-item .k{font-weight:900;color:#0b1120;font-size:12px}
    .pp-setting-item .v{font-weight:900;color:#64748b;font-size:12px}
    .pp-setting-link{display:block;text-align:center;margin-top:6px;color:#0ea5e9;font-weight:1000;text-decoration:none}

    .typing{display:inline-flex;gap:4px;align-items:center}
    .dot{width:6px;height:6px;border-radius:999px;background:#94a3b8;animation:bounce 1.1s infinite}
    .dot:nth-child(2){animation-delay:.15s}
    .dot:nth-child(3){animation-delay:.3s}
    @keyframes bounce{0%,80%,100%{transform:translateY(0);opacity:.5}40%{transform:translateY(-4px);opacity:1}}

    @media (max-width: 900px){
      .hero{padding:18px;min-height:100vh;align-items:flex-start;padding-top:72px;}
      /* Keep headlines from feeling oversized on narrow screens */
      .hero-headline{font-size:clamp(34px,9vw,52px);}
      .hero-content{max-width:100%;padding-bottom:90px;}

      .chat-launcher{right:14px;bottom:calc(14px + env(safe-area-inset-bottom));}
      .chat-peek{display:none;}

      .chat-window{left:12px;right:12px;width:auto;bottom:calc(86px + env(safe-area-inset-bottom));max-height:78vh;}

      .disc-btn{left:14px;right:auto;bottom:calc(14px + env(safe-area-inset-bottom));padding:8px 12px;font-size:11px;z-index:26000;opacity:.92;}
    }

    /* Funnel modal */
    .modal-overlay{position:fixed;inset:0;background:rgba(2,6,23,.72);backdrop-filter:blur(6px);display:none;z-index:20000;}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:18px;z-index:21000;}
    .card{width:min(760px,96vw);background:#ffffff;color:#0b1323;border-radius:18px;box-shadow:0 40px 100px rgba(0,0,0,.8);overflow:hidden;border:1px solid #e5e7eb;}

    /* Mobile-friendly CTA modal (bottom-sheet style) */
    @media (max-width: 600px){
      .modal{align-items:flex-end;}
      .card{width:100%;max-width:100%;max-height:85vh;border-radius:18px 18px 0 0;}
      .card-head{position:sticky;top:0;z-index:2;}
      .card-body{overflow:auto;-webkit-overflow-scrolling:touch;}
    }

    /* Stepper (used mainly on mobile) */
    .stepper{display:none;padding:12px 2px 10px;margin:0 0 8px;}
    .stepper-top{display:flex;align-items:baseline;justify-content:space-between;gap:10px;}
    .stepper-kicker{font-size:11px;font-weight:900;color:#64748b;letter-spacing:.02em;}
    .stepper-title{font-size:12px;font-weight:1000;color:#0b1120;}
    .stepper-dots{display:flex;gap:8px;margin-top:10px;}
    .dotx{width:10px;height:10px;border-radius:999px;background:#e2e8f0;}
    .dotx.active{background:#0b1120;}
    .stepper-bar{height:6px;border-radius:999px;background:#eef2f7;margin-top:10px;overflow:hidden;}
    .stepper-bar-fill{display:block;height:100%;width:25%;background:#0b1120;transition:width .2s ease;}

    .steps{margin-top:6px;}
    .step{display:none;}
    .step.active{display:block;}

    /* Desktop keeps the original all-sections view */
    @media (min-width: 601px){
      .stepper{display:none;}
      .step{display:block;}
      .row-mobile{display:none !important;}
    }

    /* Mobile: one step at a time + sticky step controls */
    @media (max-width: 600px){
      .stepper{display:block;}
      .grid{grid-template-columns:1fr !important;}
      .row-desktop{display:none !important;}
      .row-mobile{position:sticky;bottom:0;left:0;right:0;padding:12px 0 0;background:linear-gradient(180deg, rgba(255,255,255,0), rgba(255,255,255,1) 28%);gap:10px;justify-content:space-between;}
      .row-mobile .btn{flex:1;}
    }

    .card-head{display:flex;align-items:flex-start;justify-content:space-between;gap:14px;padding:14px 16px;background:#f8fafc;border-bottom:1px solid #e5e7eb;}
    .card-head h2{margin:0;font-size:16px;font-weight:900;}
    .card-head p{margin:2px 0 0;font-size:12px;color:#475569;max-width:none;}
    .icon-btn{background:transparent;border:none;font-size:18px;cursor:pointer;color:#475569;}
    .card-body{padding:14px 16px;}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    @media(max-width:740px){.grid{grid-template-columns:1fr;}}
    .field{display:grid;gap:6px;}
    .field label{font-size:12px;font-weight:900;color:#0f172a;}
    .field input,.field select,.field textarea{padding:12px;border-radius:12px;border:1px solid #cbd5e1;font-size:14px;}
    .field textarea{resize:vertical;min-height:90px;}
    .hint{font-size:11px;color:#64748b;font-weight:700;}
    .row{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;margin-top:12px;}
    .btn{padding:12px 14px;border-radius:12px;border:1px solid #cbd5e1;background:#fff;cursor:pointer;font-weight:900;}
    .btn-primary{border:1px solid #0b1120;background:#0b1120;color:#e5e7eb;}
    .status{display:none;margin-top:10px;font-size:12px;font-weight:800;}
    .status.ok{color:#166534;}
    .status.err{color:#b91c1c;}

    /* Disclaimer button */
    .disc-btn{position:fixed;left:18px;bottom:18px;z-index:15000;background:rgba(15,23,42,.85);backdrop-filter:blur(10px);border:1px solid rgba(148,196,255,.45);color:#e5e7eb;padding:10px 14px;border-radius:999px;font-weight:900;font-size:12px;cursor:pointer;box-shadow:0 16px 50px rgba(0,0,0,.6)}
    .disc-btn:hover{filter:brightness(1.06)}

    /* Disclaimer modal */
    .disc-overlay{position:fixed;inset:0;background:rgba(2,6,23,.72);backdrop-filter:blur(6px);display:none;z-index:30000;}
    .disc-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:18px;z-index:31000;overflow:auto;}
    .disc-card{width:min(880px,96vw);max-height:86vh;background:#ffffff;color:#0b1323;border-radius:22px;box-shadow:0 50px 130px rgba(0,0,0,.85);overflow:hidden;border:1px solid rgba(148,196,255,.35);position:relative;}
    .disc-card::before{content:"";position:absolute;inset:0;pointer-events:none;background:radial-gradient(1200px 500px at 20% -10%, rgba(56,189,248,.18), transparent 55%),radial-gradient(900px 500px at 90% 10%, rgba(34,197,94,.14), transparent 55%);}
    .disc-head{position:relative;display:flex;align-items:flex-start;justify-content:space-between;gap:14px;padding:14px 16px;background:linear-gradient(180deg,#0b1120,#0f172a);border-bottom:1px solid rgba(148,196,255,.25);color:#e5e7eb;}
    .disc-head h2{margin:0;font-size:16px;font-weight:900;letter-spacing:.01em;}
    .disc-kicker{margin:4px 0 0;font-size:12px;color:rgba(226,232,240,.9);font-weight:800;max-width:66ch;line-height:1.35;}
    .disc-icon{width:34px;height:34px;border-radius:12px;display:inline-flex;align-items:center;justify-content:center;border:1px solid rgba(148,196,255,.45);background:rgba(15,23,42,.5);box-shadow:0 10px 30px rgba(0,0,0,.35);font-weight:900;}
    .disc-head-left{display:flex;gap:12px;align-items:flex-start;}
    .disc-close{background:rgba(248,250,252,.06);border:1px solid rgba(148,196,255,.35);color:#e5e7eb;border-radius:12px;padding:8px 10px;font-weight:900;cursor:pointer;}
    .disc-close:hover{filter:brightness(1.08)}

    .disc-body{position:relative;padding:14px 16px 12px;font-size:14px;line-height:1.55;color:#0b1120;overflow:auto;max-height:calc(86vh - 62px - 74px);font-weight:700;}
    .disc-body p{margin:0 0 10px;font-weight:700;color:#0b1120;}
    .disc-body strong{font-weight:900;color:#020617;}
    .disc-sections{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    @media(max-width:860px){.disc-sections{grid-template-columns:1fr;}}

    .disc-section{border:1px solid #e5e7eb;border-radius:16px;background:#ffffff;box-shadow:0 10px 26px rgba(0,0,0,.06);overflow:hidden;}
    .disc-sec-head{display:flex;gap:10px;align-items:flex-start;padding:12px 12px;background:linear-gradient(180deg,#ffffff,#f8fafc);border-bottom:1px solid #e5e7eb;}
    .disc-sec-badge{width:30px;height:30px;border-radius:12px;display:inline-flex;align-items:center;justify-content:center;font-weight:900;color:#0b1120;border:1px solid rgba(56,189,248,.35);background:rgba(56,189,248,.12);}
    .disc-sec-title{margin:0;font-size:13px;font-weight:900;color:#0b1120;}
    .disc-sec-sub{margin:2px 0 0;font-size:11px;color:#64748b;font-weight:800;line-height:1.35;}
    .disc-sec-body{padding:12px 12px 10px;font-size:13px;color:#0b1120;}
    .disc-sec-body ul{margin:0;padding-left:18px;display:grid;gap:8px;}
    .disc-sec-body li{margin:0;}

    .disc-footer-note{margin-top:12px;padding:12px;border-radius:16px;border:1px dashed rgba(15,23,42,.25);background:rgba(248,250,252,.9);font-size:12px;color:#0f172a;font-weight:800;}

    .disc-actions{position:relative;display:flex;gap:10px;justify-content:flex-end;padding:12px 16px;background:linear-gradient(180deg,#f8fafc,#ffffff);border-top:1px solid #e5e7eb;}
    .disc-actions .btn{min-width:140px}
    .btn-accept{border:1px solid rgba(34,197,94,.35);background:linear-gradient(180deg, rgba(34,197,94,.18), rgba(34,197,94,.08));color:#0b1120;}
    .btn-accept:hover{filter:brightness(1.03)}
  @keyframes phcFadeIn {
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.cta-secondary{
  transition: opacity .35s ease, transform .35s ease;
}
.cta-secondary.visible{
  opacity:1 !important;
  pointer-events:auto !important;
  transform:translateY(0);
}

</style>
</head>

<body>

<section class="hero">
  <!-- Rotating background images (PNG) -->
  <div class="hero-rotator" aria-hidden="true">
    <img class="hero-slide active" id="heroImg0" alt="" loading="eager" decoding="async" src="hero-house.png">
    <img class="hero-slide" id="heroImg1" alt="" loading="eager" decoding="async" src="hero-auto.png">
    <img class="hero-slide" id="heroImg2" alt="" loading="eager" decoding="async" src="hero-business.png">
  </div>

  <div class="hero-content">
    <h1 class="hero-headline" id="heroHeader" data-i18n="hero_header_home">Home Insurance</h1>

    <div class="hero-cta-wrap">
      <p class="phc-hook-hero attn" id="phcHook" data-i18n="phc_hook_v1">If your life looks different than when you started your policy, your coverage may not match anymore.</p>
      <button class="cta cta-secondary" id="openHealthCheck" type="button">30-Second Policy Health Check</button>
      <button class="cta cta-secondary" id="openFunnel" type="button" data-i18n="cta_check" aria-hidden="true" style="opacity:0;pointer-events:none;">Check My Options</button>
      <div class="cta-micro" id="ctaMicro">2 minutes • Not a quote • Agent follow-up</div>
    </div>
  </div>
</section>

<!-- Lead Funnel Modal (fallback if CLICKFUNNEL_URL is blank) -->
<div class="modal-overlay" id="modalOverlay"></div>
<div class="modal" id="modal">
  <div class="card" role="dialog" aria-label="Options pre-check form">
    <div class="card-head">
      <div>
        <h2>Quick Options Pre-Check</h2>
        <p>2 minutes. Not a quote. A licensed agent reviews and follows up with carrier-agnostic options.</p>
      </div>
      <button class="icon-btn" id="closeModal" type="button">✕</button>
    </div>
    <div class="card-body">
      <form id="leadForm">
        <!-- Stepper (mobile-first) -->
        <div class="stepper" id="stepper" aria-label="Form progress">
          <div class="stepper-top">
            <div class="stepper-kicker" id="stepperKicker">Step 1 of 4</div>
            <div class="stepper-title">A quick pre-check</div>
          </div>
          <div class="stepper-dots" role="presentation">
            <span class="dotx active" data-dot="0"></span>
            <span class="dotx" data-dot="1"></span>
            <span class="dotx" data-dot="2"></span>
            <span class="dotx" data-dot="3"></span>
          </div>
          <div class="stepper-bar" aria-hidden="true"><span class="stepper-bar-fill" id="stepperBarFill"></span></div>
        </div>

        <div class="steps" id="steps">
          <!-- STEP 1 -->
          <section class="step active" data-step="0" aria-label="Step 1">
            <div class="grid">
              <div class="field">
                <label for="firstName">First name *</label>
                <input id="firstName" name="firstName" autocomplete="given-name" required />
              </div>
              <div class="field">
                <label for="lastName">Last name *</label>
                <input id="lastName" name="lastName" autocomplete="family-name" required />
              </div>
              <div class="field" style="grid-column:1 / -1;">
                <label for="zip">ZIP *</label>
                <input id="zip" name="zip" inputmode="numeric" pattern="[0-9]{5}" placeholder="81501" required />
                <div class="hint">Example reference ZIP: 81501</div>
              </div>
            </div>
          </section>

          <!-- STEP 2 -->
          <section class="step" data-step="1" aria-label="Step 2">
            <div class="grid">
              <div class="field">
                <label for="email">Email *</label>
                <input id="email" name="email" type="email" autocomplete="email" required />
              </div>
              <div class="field">
                <label for="phone">Mobile phone *</label>
                <input id="phone" name="phone" type="tel" autocomplete="tel" required />
              </div>
              <div class="field">
                <label for="homeowner">Home status *</label>
                <select id="homeowner" name="homeowner" required>
                  <option value="">Select…</option>
                  <option>Own</option>
                  <option>Rent</option>
                  <option>Buying soon</option>
                </select>
              </div>
              <div class="field">
                <label for="vehicles">Vehicles insured *</label>
                <select id="vehicles" name="vehicles" required>
                  <option value="">Select…</option>
                  <option>1</option><option>2</option><option>3</option><option>4+</option>
                </select>
              </div>
              <div class="field" style="grid-column:1 / -1;">
                <label for="timeframe">When do you need this? *</label>
                <select id="timeframe" name="timeframe" required>
                  <option value="">Select…</option>
                  <option>ASAP</option>
                  <option>Within 7 days</option>
                  <option>Within 30 days</option>
                  <option>Just exploring</option>
                </select>
              </div>
            </div>
          </section>

          <!-- STEP 3: Policy Health Check -->
          <section class="step" data-step="2" aria-label="Step 3">
            <div class="grid phc-desktop-grid">
              <div class="field" style="grid-column:1 / -1;">
                <label style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
                  <span>Policy Health Check</span>
                  <span class="hint" style="margin:0;">Takes ~30 seconds</span>
                </label>
                <div class="hint">Answer a few simple questions so we can spot common coverage gaps (general info; agent review required).</div>
              </div>

              <div class="field" style="grid-column:1 / -1;">
                <label>1) Any life changes in the last 12 months? (select all)</label>
                <div class="hint">Changes are the #1 reason policies stop matching real life.</div>
                <div class="phc-grid" id="phcChanges">
                  <label class="phc-chip"><input type="checkbox" value="Moved/bought home">Moved/bought home</label>
                  <label class="phc-chip"><input type="checkbox" value="New driver/teen driver">New driver/teen driver</label>
                  <label class="phc-chip"><input type="checkbox" value="New vehicle/financed/leased">New vehicle/financed/leased</label>
                  <label class="phc-chip"><input type="checkbox" value="Marriage/divorce/new baby">Marriage/divorce/new baby</label>
                  <label class="phc-chip"><input type="checkbox" value="Work from home/home business">Work from home/home business</label>
                  <label class="phc-chip"><input type="checkbox" value="Major remodel/new roof/solar">Major remodel/new roof/solar</label>
                  <label class="phc-chip"><input type="checkbox" value="None">None</label>
                </div>
              </div>

              <div class="field">
                <label for="phcProperty">2) Property situation *</label>
                <select id="phcProperty" name="phcProperty" required>
                  <option value="">Select…</option>
                  <option>Own a home</option>
                  <option>Rent</option>
                  <option>Condo/Townhome</option>
                  <option>Landlord/Rental property</option>
                  <option>Not sure</option>
                </select>
              </div>

              <div class="field">
                <label for="phcDeductible">3) Comfortable out-of-pocket if a claim happened tomorrow? *</label>
                <select id="phcDeductible" name="phcDeductible" required>
                  <option value="">Select…</option>
                  <option>$500–$1,000</option>
                  <option>$1,000–$2,500</option>
                  <option>$2,500–$5,000+</option>
                  <option>Not sure</option>
                </select>
              </div>

              <div class="field">
                <label for="phcLiability">4) If you were sued after an accident/injury, how protected do you feel? *</label>
                <select id="phcLiability" name="phcLiability" required>
                  <option value="">Select…</option>
                  <option>Very protected (high liability / umbrella)</option>
                  <option>Somewhat protected</option>
                  <option>Not protected / Not sure</option>
                </select>
              </div>

              <div class="field">
                <label for="phcReview">5) Last full policy review with a licensed agent? *</label>
                <select id="phcReview" name="phcReview" required>
                  <option value="">Select…</option>
                  <option>Within 12 months</option>
                  <option>1–3 years ago</option>
                  <option>3+ years ago / never</option>
                  <option>Not sure</option>
                </select>
              </div>

              <div class="field" style="grid-column:1 / -1;">
                <label>Optional: Any property risk flags? (select all)</label>
                <div class="phc-grid" id="phcRisks">
                  <label class="phc-chip"><input type="checkbox" value="Wildfire/brush nearby">Wildfire/brush nearby</label>
                  <label class="phc-chip"><input type="checkbox" value="Hail-prone / roof 10+ yrs">Hail-prone / roof 10+ yrs</label>
                  <label class="phc-chip"><input type="checkbox" value="Basement/sump pump">Basement/sump pump</label>
                  <label class="phc-chip"><input type="checkbox" value="Pool/trampoline/dog">Pool/trampoline/dog</label>
                  <label class="phc-chip"><input type="checkbox" value="Not sure">Not sure</label>
                  <label class="phc-chip"><input type="checkbox" value="None">None</label>
                </div>
              </div>
            </div>

            <!-- Desktop: result + CTA (stays inside modal; proceeds to Options step) -->
            <div class="phc-result" id="phcResult" aria-live="polite">
              <div class="phc-result-top">
                <div class="phc-result-left">
                  <span class="phc-dot" id="phcDot" aria-hidden="true"></span>
                  <div>
                    <div class="phc-result-label" id="phcLabel">Green</div>
                  </div>
                </div>
                <button class="btn phc-run" id="phcRun" type="button">Show my result</button>
              </div>
              <div class="phc-result-copy" id="phcCopy"></div>
              <ul class="phc-result-why" id="phcWhy"></ul>
              <div class="phc-summary" id="phcSummary" style="display:none;"></div>
              <div class="phc-result-actions">
                <button class="btn btn-primary phc-continue" id="phcCta" type="button" style="display:none;">Continue to Options</button>
              </div>
            </div>

            <!-- Mobile: tap-to-advance flow (keeps the same underlying fields for submission) -->
            <div class="phc-mobile-flow" id="phcMobileFlow" aria-label="Policy Health Check mobile flow">
              <div class="phc-q" id="phcQ0">
                <p class="phc-q-title">1) Any life changes in the last 12 months?</p>
                <p class="phc-q-hint">Tap any that apply (you can choose multiple). Then continue.</p>
                <div class="phc-answers" id="phcMobileChanges"></div>
                <div class="phc-mobile-nav">
                  <button class="btn" type="button" id="phcBack0" disabled>Back</button>
                  <button class="btn btn-primary" type="button" id="phcNext0">Continue</button>
                </div>
              </div>

              <div class="phc-q" id="phcQ1" style="display:none;">
                <p class="phc-q-title">2) Property situation *</p>
                <p class="phc-q-hint">Tap one option.</p>
                <div class="phc-answers" id="phcMobileProperty"></div>
                <div class="phc-mobile-nav">
                  <button class="btn" type="button" id="phcBack1">Back</button>
                  <button class="btn btn-primary" type="button" id="phcNext1">Continue</button>
                </div>
              </div>

              <div class="phc-q" id="phcQ2" style="display:none;">
                <p class="phc-q-title">3) Comfortable out-of-pocket if a claim happened tomorrow? *</p>
                <p class="phc-q-hint">Tap one option.</p>
                <div class="phc-answers" id="phcMobileDeductible"></div>
                <div class="phc-mobile-nav">
                  <button class="btn" type="button" id="phcBack2">Back</button>
                  <button class="btn btn-primary" type="button" id="phcNext2">Continue</button>
                </div>
              </div>

              <div class="phc-q" id="phcQ3" style="display:none;">
                <p class="phc-q-title">4) If you were sued after an accident/injury, how protected do you feel? *</p>
                <p class="phc-q-hint">Tap one option.</p>
                <div class="phc-answers" id="phcMobileLiability"></div>
                <div class="phc-mobile-nav">
                  <button class="btn" type="button" id="phcBack3">Back</button>
                  <button class="btn btn-primary" type="button" id="phcNext3">Continue</button>
                </div>
              </div>

              <div class="phc-q" id="phcQ4" style="display:none;">
                <p class="phc-q-title">5) Last full policy review with a licensed agent? *</p>
                <p class="phc-q-hint">Tap one option.</p>
                <div class="phc-answers" id="phcMobileReview"></div>
                <div class="phc-mobile-nav">
                  <button class="btn" type="button" id="phcBack4">Back</button>
                  <button class="btn btn-primary" type="button" id="phcNext4">Continue</button>
                </div>
              </div>

              <div class="phc-q" id="phcQ5" style="display:none;">
                <p class="phc-q-title">Optional: Any property risk flags?</p>
                <p class="phc-q-hint">Tap any that apply (you can choose multiple). Then finish.</p>
                <div class="phc-answers" id="phcMobileRisks"></div>
                <div class="phc-mobile-nav">
                  <button class="btn" type="button" id="phcBack5">Back</button>
                  <button class="btn btn-primary" type="button" id="phcFinish">Finish</button>
                </div>
              </div>

              <div class="phc-q" id="phcQDone" style="display:none;">
                <p class="phc-q-title">✅ Policy Health Check complete</p>
                <p class="phc-q-hint">Based on your answers:</p>

                <div class="phc-result show" id="phcResultMobile" aria-live="polite">
                  <div class="phc-result-top">
                    <div class="phc-result-left">
                      <span class="phc-dot" id="phcDotMobile" aria-hidden="true"></span>
                      <div>
                        <div class="phc-result-label" id="phcLabelMobile">Green</div>
                      </div>
                    </div>
                  </div>
                  <div class="phc-result-copy" id="phcCopyMobile"></div>
                  <ul class="phc-result-why" id="phcWhyMobile"></ul>
                  <div class="phc-summary" id="phcSummaryMobile" style="display:none;"></div>
                  <div class="phc-result-actions">
                    <button class="btn btn-primary phc-continue" id="phcCtaMobile" type="button" style="display:none;">Continue to Options</button>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- STEP 4 -->
          <section class="step" data-step="3" aria-label="Step 4">
            <div class="grid">
              <div class="field" style="grid-column:1 / -1;">
                <label for="roofAge">Roof age</label>
                <select id="roofAge" name="roofAge">
                  <option value="">Select…</option>
                  <option>0-5</option><option>6-10</option><option>11-15</option><option>16-20</option><option>21+</option><option>Not sure</option>
                </select>
              </div>
              <div class="field" style="grid-column:1 / -1;">
                <label for="notes">Notes (optional)</label>
                <textarea id="notes" name="notes" placeholder="Any details that help (hail claim history, wildfire concerns, bundling, etc.)"></textarea>
              </div>
              <div class="field" style="grid-column:1 / -1;">
                <label style="display:flex;gap:10px;align-items:flex-start;font-weight:800;color:#0f172a;">
                  <input id="consent" type="checkbox" required style="margin-top:2px;" />
                  I agree to be contacted by phone, SMS, and email about insurance options. Msg &amp; data rates may apply.
                </label>
              </div>
            </div>
          </section>
        </div>

        <!-- Desktop buttons -->
        <div class="row row-desktop" id="rowDesktop">
          <button class="btn" id="cancelBtn" type="button">Cancel</button>
          <button class="btn btn-primary" id="submitBtn" type="submit">Submit</button>
        </div>

        <!-- Mobile step buttons -->
        <div class="row row-mobile" id="rowMobile" aria-label="Step controls">
          <button class="btn" id="stepBack" type="button">Back</button>
          <button class="btn btn-primary" id="stepNext" type="button">Next</button>
          <button class="btn btn-primary" id="stepSubmit" type="submit" style="display:none;">Submit</button>
        </div>

        <div class="status" id="formStatus"></div>
      </form>
    </div>
  </div>
</div>

<!-- Disclaimer launcher -->
<button class="disc-btn" id="openDisclaimer" type="button" data-i18n="disclaimer_btn">Disclaimer</button>

<!-- Disclaimer modal -->
<div class="disc-overlay" id="discOverlay"></div>
<div class="disc-modal" id="discModal" role="dialog" aria-label="Legal disclaimer">
  <div class="disc-card">
    <div class="disc-head">
      <div class="disc-head-left">
        <div class="disc-icon">⚖</div>
        <div>
          <h2>Legal Disclaimer</h2>
          <div class="disc-kicker">Please review. This site includes AI-assisted information. <b>Human review is required</b> before any quote, application, binding, or policy change.</div>
        </div>
      </div>
      <button class="disc-close" id="discClose" type="button" aria-label="Close disclaimer">Close ✕</button>
    </div>
    <div class="disc-body">
      <div class="disc-sections">
        <section class="disc-section">
          <div class="disc-sec-head">
            <div class="disc-sec-badge">i</div>
            <div>
              <p class="disc-sec-title">General information only</p>
              <p class="disc-sec-sub">Not legal, tax, or financial advice</p>
            </div>
          </div>
          <div class="disc-sec-body">
            <ul>
              <li>This page and <strong>PolicyPro™</strong> provide <strong>general educational information</strong> about insurance concepts.</li>
              <li>Nothing here is legal advice, tax advice, or a substitute for professional guidance.</li>
              <li>Examples (including ZIP <strong>81501</strong>) are <strong>illustrative only</strong>.</li>
            </ul>
          </div>
        </section>

        <section class="disc-section">
          <div class="disc-sec-head">
            <div class="disc-sec-badge">AI</div>
            <div>
              <p class="disc-sec-title">AI disclosure</p>
              <p class="disc-sec-sub">AI output can be wrong or incomplete</p>
            </div>
          </div>
          <div class="disc-sec-body">
            <ul>
              <li><strong>PolicyPro™</strong> includes automated and artificial-intelligence–generated responses for general informational purposes.</li>
              <li>AI output may be incomplete, inaccurate, or outdated and must not be relied upon as a definitive statement of coverage, pricing, underwriting eligibility, or claim outcome.</li>
              <li>AI responses do <strong>not</strong> replace advice from a licensed insurance producer.</li>
            </ul>
          </div>
        </section>

        <section class="disc-section">
          <div class="disc-sec-head">
            <div class="disc-sec-badge">✓</div>
            <div>
              <p class="disc-sec-title">Human review required</p>
              <p class="disc-sec-sub">Before quotes, applications, or changes</p>
            </div>
          </div>
          <div class="disc-sec-body">
            <ul>
              <li>Any quote indications, coverage discussions, or next steps require <strong>review and confirmation</strong> by a licensed insurance agent before any application is submitted or coverage is bound.</li>
              <li>Nothing on this page constitutes an offer to sell insurance or bind coverage.</li>
            </ul>
          </div>
        </section>

        <section class="disc-section">
          <div class="disc-sec-head">
            <div class="disc-sec-badge">🛡</div>
            <div>
              <p class="disc-sec-title">Coverage &amp; claims limitations</p>
              <p class="disc-sec-sub">Carrier rules and policy terms control</p>
            </div>
          </div>
          <div class="disc-sec-body">
            <ul>
              <li>Coverage, eligibility, rates, discounts, underwriting, and availability vary by carrier and are subject to policy terms, conditions, exclusions, limits, and deductibles.</li>
              <li>Claim scenario walkthroughs are general and may not apply to your situation. Always follow your policy and carrier instructions. If there is immediate danger, call emergency services.</li>
            </ul>
          </div>
        </section>
      </div>

      <div class="disc-footer-note">
        <strong>Consent &amp; privacy:</strong> By submitting your information, you authorize contact by phone, SMS, and email about insurance options (msg &amp; data rates may apply). Information may be stored in a secure Google Sheet and emailed to the business inbox for follow-up. Do not submit sensitive information you do not want transmitted electronically.
      </div>
    </div>

    <div class="disc-actions">
      <button class="btn btn-accept" id="discAccept" type="button">I Accept</button>
      <button class="btn btn-primary" id="discClose2" type="button">Close</button>
    </div>
  </div>
</div>

<!-- Channel.io-style launcher -->
<div class="chat-launcher" id="chatBtn" aria-label="Open PolicyPro chat" title="Ask PolicyPro™ a question">
  <div class="chat-peek" aria-hidden="true">
    <div class="chat-label" data-i18n="chat_peek_label">Need help?</div>
    <div class="chat-name" data-i18n="chat_peek_name">Chat with PolicyPro™</div>
  </div>
  <div class="chat-bubble" role="button" aria-label="Chat bubble">
    <div class="chat-avatar">PP</div>
  </div>
</div>

<div class="chat-window" id="chatWindow" aria-label="PolicyPro widget" role="dialog">
  <div class="pp-widget">
    <div class="pp-top" aria-hidden="true">
      <div class="pp-topbar">
        <div class="pp-brand">PolicyPro™</div>
      </div>
    </div>

    <div class="pp-body">
      <!-- HOME -->
      <div class="pp-screen active" id="ppScreenHome">
        <div class="pp-home-card">
          <div class="pp-home-row">
            <div class="pp-avatar">PP</div>
            <div>
              <p class="pp-home-title" data-i18n="pp_home_title">Hi — how can we help?</p>
              <p class="pp-home-sub" data-i18n="pp_home_sub">Ask a Colorado home or auto insurance question. General info only — a licensed agent reviews before any quote, application, or binding.</p>
            </div>
          </div>
          <button class="pp-primary" id="ppStartChat" type="button"><span data-i18n="pp_start_chat">Start a chat</span> <span aria-hidden="true">➤</span></button>
        </div>
        <div class="pp-footer-note" data-i18n="pp_powered">Powered by PolicyPro</div>
      </div>

      <!-- MESSAGES -->
      <div class="pp-screen" id="ppScreenMessages">
        <div class="pp-messages-wrap">
          <div class="chat-main">
            <div class="chat-messages" id="chatMessages" aria-live="polite"></div>

            <form class="chat-inputbar" id="chatForm" autocomplete="off">
              <input class="chat-input" id="chatInput" type="text" placeholder="Ask about hail deductibles, wildfire coverage, bundling…" data-i18n-placeholder="chat_placeholder" />
              <button class="send-btn" id="chatSend" type="submit" data-i18n="chat_send">Send</button>
            </form>
          </div>
        </div>
      </div>

      <!-- SETTINGS -->
      <div class="pp-screen" id="ppScreenSettings">
        <div class="pp-settings">
          <h3 data-i18n="settings_title">Settings</h3>
          <div class="pp-setting-item"><div class="k" data-i18n="settings_contact">Contact</div><div class="v" id="ppAgentEmail">securechoicein@gmail.com</div></div>
          <div class="pp-setting-item">
            <div class="k" data-i18n="settings_language">Language</div>
            <div class="v">
              <select id="ppLangSelect" class="pp-select" aria-label="Select language">
                <option value="en">English</option>
                <option value="es">Spanish</option>
                <option value="ja">Japanese</option>
                <option value="zh">Chinese</option>
                <option value="fr">French</option>
                <option value="ru">Russian</option>
              </select>
            </div>
          </div>
          <div class="pp-setting-item"><div class="k" data-i18n="settings_disclaimer">Disclaimer</div><div class="v" data-i18n="settings_available">Available</div></div>
          <a class="pp-setting-link" href="#" id="ppOpenDisclaimerLink" data-i18n="settings_open_disclaimer">Open legal disclaimer</a>
        </div>
      </div>
    </div>

    <div class="pp-tabs" role="tablist" aria-label="Widget tabs">
      <button class="pp-tab active" id="ppTabHome" type="button" role="tab" aria-selected="true" aria-controls="ppScreenHome">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M3 10.5 12 3l9 7.5"/><path d="M5 10v10h14V10"/></svg>
        <span data-i18n="tab_home">Home</span>
      </button>
      <button class="pp-tab" id="ppTabMessages" type="button" role="tab" aria-selected="false" aria-controls="ppScreenMessages">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M21 15a4 4 0 0 1-4 4H8l-5 3V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"/></svg>
        <span data-i18n="tab_messages">Messages</span>
      </button>
      <button class="pp-tab" id="ppTabSettings" type="button" role="tab" aria-selected="false" aria-controls="ppScreenSettings">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z"/><path d="M19.4 15a1.7 1.7 0 0 0 .3 1.8l.1.1a2 2 0 0 1-1.4 3.4h-.2a1.8 1.8 0 0 0-1.7 1.3 2 2 0 0 1-3.8 0 1.8 1.8 0 0 0-1.7-1.3H9a2 2 0 0 1-1.4-3.4l.1-.1A1.7 1.7 0 0 0 8.6 15a1.8 1.8 0 0 0-.7-1.7 2 2 0 0 1 0-3.1 1.8 1.8 0 0 0 .7-1.7 1.7 1.7 0 0 0-.3-1.8l-.1-.1A2 2 0 0 1 9.6 3h.2a1.8 1.8 0 0 0 1.7-1.3 2 2 0 0 1 3.8 0 1.8 1.8 0 0 0 1.7 1.3h.2a2 2 0 0 1 1.4 3.4l-.1.1a1.7 1.7 0 0 0-.3 1.8 1.8 1.8 0 0 0 .7 1.7 2 2 0 0 1 0 3.1 1.8 1.8 0 0 0-.7 1.7 1.7 1.7 0 0 0 .3 1.8l.1.1a2 2 0 0 1-1.4 3.4h-.2a1.8 1.8 0 0 0-1.7 1.3 2 2 0 0 1-3.8 0 1.8 1.8 0 0 0-1.7-1.3H9a2 2 0 0 1-1.4-3.4l.1-.1A1.7 1.7 0 0 0 8.6 15a1.8 1.8 0 0 0-.7-1.7 2 2 0 0 1 0-3.1 1.8 1.8 0 0 0 .7-1.7 1.7 1.7 0 0 0-.3-1.8l-.1-.1A2 2 0 0 1 9.6 3h.2a1.8 1.8 0 0 0 1.7-1.3 2 2 0 0 1 3.8 0 1.8 1.8 0 0 0 1.7 1.3h.2a2 2 0 0 1 1.4 3.4l-.1.1a1.7 1.7 0 0 0-.3 1.8 1.8 1.8 0 0 0 .7 1.7 2 2 0 0 1 0 3.1 1.8 1.8 0 0 0-.7 1.7z"/></svg>
        <span data-i18n="tab_settings">Settings</span>
      </button>
    </div>
  </div>

  <button class="pp-close-fab" id="closeChat" aria-label="Close chat" type="button">✕</button>
</div>

<script>
  // ===== Lead funnel + Google Apps Script backend =====
  var GAS = window.GAS_WEBAPP_URL || "";
  var CLICKFUNNEL_URL = (window.CLICKFUNNEL_URL || '').trim();

  var openFunnelBtn = document.getElementById('openFunnel');
  var openHealthCheckBtn = document.getElementById('openHealthCheck');

  // ===== Optional: gently de-emphasize "Check My Options" until the Health Check has been seen once =====
  var PHC_SEEN_KEY = 'sc_phc_seen_v1';
  function hasSeenPHC_(){ try{ return localStorage.getItem(PHC_SEEN_KEY) === '1'; }catch(e){ return false; } }
  function markSeenPHC_(){ try{ localStorage.setItem(PHC_SEEN_KEY,'1'); }catch(e){} }
  function applyPHCGate_(){
    try{
      if(!document.body) return;
      if(hasSeenPHC_()) document.body.classList.remove('phc-gate');
      else document.body.classList.add('phc-gate');
    }catch(e){}
  }
  function setupPHCGate_(){
    applyPHCGate_();

    // Clicking Health Check counts as "seen"
    try{
      if(openHealthCheckBtn){
        openHealthCheckBtn.addEventListener('click', function(){
          markSeenPHC_();
          applyPHCGate_();
        }, { once:false });
      }
    }catch(e){}

    // If the hook or button becomes visible, count as "seen" (no click required)
    try{
      var hook = document.getElementById('phcHook');
      var target = hook || openHealthCheckBtn;
      if(target && 'IntersectionObserver' in window){
        var io = new IntersectionObserver(function(entries){
          for(var i=0;i<entries.length;i++){
            if(entries[i].isIntersecting){
              markSeenPHC_();
              applyPHCGate_();
              try{ io.disconnect(); }catch(err){}
              break;
            }
          }
        }, { root:null, threshold:0.35 });
        io.observe(target);
      }
    }catch(e){}
  }
  if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', setupPHCGate_);
  else setupPHCGate_();

  var modalOverlay = document.getElementById('modalOverlay');
  var modal = document.getElementById('modal');
  var closeModalBtn = document.getElementById('closeModal');
  var cancelBtn = document.getElementById('cancelBtn');
  var leadForm = document.getElementById('leadForm');
  var formStatus = document.getElementById('formStatus');

  function showModal(){ if(modalOverlay) modalOverlay.style.display='block'; if(modal) modal.style.display='flex'; try{ resetStepper_(); }catch(e){} }
  function hideModal(){ if(modalOverlay) modalOverlay.style.display='none'; if(modal) modal.style.display='none'; try{ resetStepper_(); }catch(e){} }

  if(closeModalBtn) closeModalBtn.addEventListener('click', hideModal);
  if(cancelBtn) cancelBtn.addEventListener('click', hideModal);
  if(modalOverlay) modalOverlay.addEventListener('click', hideModal);

  // Policy Health Check button opens the same stepper flow directly on Step 3 (Policy Health Check)
  if(openHealthCheckBtn) openHealthCheckBtn.addEventListener('click', function(){
    showModal();
    try{ if(isMobile_()) setStep_(2); }catch(e){}
  });

  // Open funnel: ClickFunnels if configured, otherwise in-page modal
  if(openFunnelBtn){
    openFunnelBtn.addEventListener('click', function(){
      if(CLICKFUNNEL_URL){
        window.location.href = CLICKFUNNEL_URL;
      }else{
        showModal();
      }
    });
  }

  // ===== Step-based mobile funnel =====
  var stepsWrap = document.getElementById('steps');
  var stepKicker = document.getElementById('stepperKicker');
  var stepBarFill = document.getElementById('stepperBarFill');
  var stepDots = document.querySelectorAll('.dotx');
  var stepBack = document.getElementById('stepBack');
  var stepNext = document.getElementById('stepNext');
  var stepSubmit = document.getElementById('stepSubmit');

  var __stepIndex = 0;
  var __stepTotal = 4;

  function isMobile_(){ return window.matchMedia && window.matchMedia('(max-width: 600px)').matches; }

  function setStep_(idx){
    __stepIndex = Math.max(0, Math.min(__stepTotal-1, idx|0));

    if(stepsWrap){
      var stepEls = stepsWrap.querySelectorAll('.step');
      for(var i=0;i<stepEls.length;i++) stepEls[i].classList.toggle('active', i === __stepIndex);
    }

    if(stepDots && stepDots.length){
      for(var d=0;d<stepDots.length;d++) stepDots[d].classList.toggle('active', d === __stepIndex);
    }

    if(stepKicker) stepKicker.textContent = 'Step ' + (__stepIndex+1) + ' of ' + __stepTotal;
    if(stepBarFill) stepBarFill.style.width = (((__stepIndex+1) / __stepTotal) * 100) + '%';

    if(stepBack) stepBack.style.display = (__stepIndex === 0) ? 'none' : 'inline-flex';
    if(stepNext) stepNext.style.display = (__stepIndex === __stepTotal-1) ? 'none' : 'inline-flex';
    if(stepSubmit) stepSubmit.style.display = (__stepIndex === __stepTotal-1) ? 'inline-flex' : 'none';

    try{
      if(isMobile_() && stepsWrap){
        var cur = stepsWrap.querySelector('.step.active');
        if(cur){
          var focusEl = cur.querySelector('input,select,textarea');
          if(focusEl) setTimeout(function(){ focusEl.focus(); }, 50);
        }
      }
    }catch(e){}
  }

  function validateStep_(idx){
    if(!stepsWrap) return true;
    var stepEls = stepsWrap.querySelectorAll('.step');
    var cur = stepEls && stepEls[idx];
    if(!cur) return true;

    var fields = cur.querySelectorAll('input,select,textarea');
    for(var i=0;i<fields.length;i++){
      var el = fields[i];
      if(el && typeof el.reportValidity === 'function'){
        if(!el.checkValidity()){
          el.reportValidity();
          return false;
        }
      }
    }
    return true;
  }

  function resetStepper_(){ if(isMobile_()) setStep_(0); }

  if(stepBack) stepBack.addEventListener('click', function(){ setStep_(__stepIndex - 1); });
  if(stepNext) stepNext.addEventListener('click', function(){ if(validateStep_(__stepIndex)) setStep_(__stepIndex + 1); });

  window.addEventListener('resize', function(){ try{ if(isMobile_()) resetStepper_(); }catch(e){} });

  // ===== Reliable Apps Script submit from GitHub Pages =====
  // Your Apps Script doPost() reads JSON from e.postData.contents,
  // so we send a JSON body via fetch() with mode:'no-cors' to avoid CORS/preflight issues.
  function postToGAS(url, payload){
    return new Promise(function(resolve, reject){
      try{
        if(!url || url.indexOf('http') !== 0){ reject(new Error('Invalid GAS URL')); return; }

        fetch(url, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify(payload || {})
        }).then(function(){
          // no-cors responses are opaque; treat as success once request is sent.
          resolve({ ok:true, opaque:true });
        }).catch(function(err){
          reject(err);
        });
      }catch(e){
        reject(e);
      }
    });
  }

  // ===== PolicyPro DOM refs =====
  var chatHistory = [];
  var chatBtn = document.getElementById('chatBtn');
  var chatWindow = document.getElementById('chatWindow');
  var closeChat = document.getElementById('closeChat');

  var ppTabHome = document.getElementById('ppTabHome');
  var ppTabMessages = document.getElementById('ppTabMessages');
  var ppTabSettings = document.getElementById('ppTabSettings');

  var ppScreenHome = document.getElementById('ppScreenHome');
  var ppScreenMessages = document.getElementById('ppScreenMessages');
  var ppScreenSettings = document.getElementById('ppScreenSettings');

  var ppStartChat = document.getElementById('ppStartChat');
  var ppLangSelect = document.getElementById('ppLangSelect');
  var ppOpenDisclaimerLink = document.getElementById('ppOpenDisclaimerLink');

  var chatMessages = document.getElementById('chatMessages');
  var chatForm = document.getElementById('chatForm');
  var chatInput = document.getElementById('chatInput');
  var chatSend = document.getElementById('chatSend');

  function setTab_(tab){
    tab = String(tab || 'home').toLowerCase();
    if(tab !== 'home' && tab !== 'messages' && tab !== 'settings') tab = 'home';

    if(ppScreenHome) ppScreenHome.classList.toggle('active', tab === 'home');
    if(ppScreenMessages) ppScreenMessages.classList.toggle('active', tab === 'messages');
    if(ppScreenSettings) ppScreenSettings.classList.toggle('active', tab === 'settings');

    function setTabBtn(btn, active){
      if(!btn) return;
      btn.classList.toggle('active', !!active);
      btn.setAttribute('aria-selected', active ? 'true' : 'false');
    }
    setTabBtn(ppTabHome, tab === 'home');
    setTabBtn(ppTabMessages, tab === 'messages');
    setTabBtn(ppTabSettings, tab === 'settings');

    if(tab === 'messages'){
      try{ renderSuggestedQuestions_(); }catch(e){}
      try{ if(chatInput) chatInput.focus(); }catch(e){}
    }
  }

  // Persist chat
  var PP_CHAT_KEY = 'pp_chat_state_v1';
  function loadChatState_(){ try{ var raw = localStorage.getItem(PP_CHAT_KEY); return raw ? JSON.parse(raw) : null; }catch(e){ return null; } }
  function saveChatState_(){
    try{
      var state = { history: chatHistory.slice(-60), rendered: [] };
      if(chatMessages){
        var msgEls = chatMessages.querySelectorAll('.msg');
        for(var i=0;i<msgEls.length;i++){
          var isUser = msgEls[i].classList.contains('user');
          var bub = msgEls[i].querySelector('.bubble');
          state.rendered.push({ role: isUser ? 'user' : 'bot', html: bub ? bub.innerHTML : '' });
        }
      }
      localStorage.setItem(PP_CHAT_KEY, JSON.stringify(state));
    }catch(e){}
  }

  function restoreChatUI_(){
    var state = loadChatState_();
    if(!state || !chatMessages) return;

    try{
      chatMessages.innerHTML = '';
      if(Array.isArray(state.rendered) && state.rendered.length){
        state.rendered.forEach(function(m){
          var wrap = document.createElement('div');
          wrap.className = 'msg ' + (m.role === 'user' ? 'user' : 'bot');
          var b = document.createElement('div');
          b.className = 'bubble ' + (m.role === 'user' ? 'user' : 'bot');
          b.innerHTML = m.html || '';
          wrap.appendChild(b);
          chatMessages.appendChild(wrap);
        });
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
      if(Array.isArray(state.history)) chatHistory = state.history;
    }catch(e){}
  }
  restoreChatUI_();

  // =========================
  // i18n
  // =========================
  var PP_LANG_KEY = 'pp_lang_v1';
  function getLang_(){ try{ return (localStorage.getItem(PP_LANG_KEY) || 'en'); }catch(e){ return 'en'; } }
  function setLang_(v){ try{ localStorage.setItem(PP_LANG_KEY, String(v||'en')); }catch(e){} }

  function i18nDict_(){
  return {
    en:{
      doc_title:'Colorado Relief Options — Home & Auto Insurance',
      meta_desc:'Colorado residents: explore flexible home & auto insurance options designed to protect your budget and peace of mind.',
      hero_h1:'Get flexible home & auto options that fit your budget and protect what matters.',
      hero_header_home:'Home Insurance',
      hero_header_auto:'Car Insurance',
      hero_header_business:'Business Insurance',
      cta_check:'Check My Options',
      disclaimer_btn:'Disclaimer',
      chat_peek_label:'Need help?',
      chat_peek_name:'Chat with PolicyPro™',
      pp_home_title:'Hi — how can we help?',
      pp_home_sub:'Ask a Colorado home or auto insurance question. General info only — a licensed agent reviews before any quote, application, or binding.',
      pp_start_chat:'Start a chat',
      tab_home:'Home',
      tab_messages:'Messages',
      tab_settings:'Settings',
      settings_title:'Settings',
      settings_contact:'Contact',
      settings_language:'Language',
      settings_disclaimer:'Disclaimer',
      settings_available:'Available',
      settings_open_disclaimer:'Open legal disclaimer',
      chat_placeholder:'Ask about hail deductibles, wildfire coverage, bundling…',
      chat_send:'Send',
      suggest_title:'Popular questions',
      suggest_home:'HOME INSURANCE',
      suggest_auto:'CAR INSURANCE',
      s_home_1:'Does home insurance cover hail and roof damage?',
      s_home_2:'What is a wind/hail deductible (and why is it different)?',
      s_home_3:'What should I check for wildfire/smoke coverage?',
      s_auto_1:'Is hail damage covered on auto insurance?',
      s_auto_2:'What does comprehensive vs collision cover?',
      s_auto_3:'How can I lower my auto premium without losing coverage?',

      /* PHC result-based CTA */
      phc_based_on:'Based on what you shared…',
      phc_cta_green:'Confirm My Coverage',
      phc_cta_yellow:'Fix Potential Gaps',
      phc_cta_red:'Review My Policy Now'
    },
    es:{
      doc_title:'Opciones en Colorado — Seguro de hogar y auto',
      meta_desc:'Residentes de Colorado: explore opciones flexibles de seguro de hogar y auto para proteger su presupuesto y tranquilidad.',
      hero_h1:'Obtén opciones flexibles de hogar y auto que se ajusten a tu presupuesto y protejan lo importante.',
      hero_header_home:'Seguro de hogar',
      hero_header_auto:'Seguro de auto',
      hero_header_business:'Seguro para negocios',
      cta_check:'Ver mis opciones',
      disclaimer_btn:'Aviso legal',
      chat_peek_label:'¿Necesitas ayuda?',
      chat_peek_name:'Chatea con PolicyPro™',
      pp_home_title:'Hola — ¿en qué podemos ayudar?',
      pp_home_sub:'Haz una pregunta sobre seguro de hogar o auto en Colorado. Solo info general — un agente con licencia revisa antes de cualquier cotización o contratación.',
      pp_start_chat:'Iniciar chat',
      tab_home:'Inicio',
      tab_messages:'Mensajes',
      tab_settings:'Ajustes',
      settings_title:'Ajustes',
      settings_contact:'Contacto',
      settings_language:'Idioma',
      settings_disclaimer:'Aviso',
      settings_available:'Disponible',
      settings_open_disclaimer:'Abrir aviso legal',
      chat_placeholder:'Pregunta sobre deducibles por granizo, cobertura de incendios, paquetes…',
      chat_send:'Enviar',
      suggest_title:'Preguntas populares',
      suggest_home:'SEGURO DE HOGAR',
      suggest_auto:'SEGURO DE AUTO',
      s_home_1:'¿El seguro de hogar cubre granizo y daño del techo?',
      s_home_2:'¿Qué es un deducible por viento/granizo?',
      s_home_3:'¿Qué debo revisar para cobertura de incendio/humo?',
      s_auto_1:'¿El granizo está cubierto en el seguro de auto?',
      s_auto_2:'¿Qué cubre comprensivo vs colisión?',
      s_auto_3:'¿Cómo bajo mi prima sin perder cobertura?',

      /* PHC result-based CTA */
      phc_based_on:'Según lo que compartiste…',
      phc_cta_green:'Confirmar mi cobertura',
      phc_cta_yellow:'Corregir posibles vacíos',
      phc_cta_red:'Revisar mi póliza ahora'
    },
    ja:{
      doc_title:'コロラド保険オプション — 住宅・自動車',
      meta_desc:'コロラド州向け。住宅保険・自動車保険の柔軟な選択肢を確認できます。',
      hero_h1:'予算に合う住宅・自動車の柔軟な選択肢。大切なものを守る。',
      hero_header_home:'住宅保険',
      hero_header_auto:'自動車保険',
      hero_header_business:'事業保険',
      cta_check:'オプションを見る',
      disclaimer_btn:'免責事項',
      chat_peek_label:'お困りですか？',
      chat_peek_name:'PolicyPro™ に質問',
      pp_home_title:'こんにちは — どうしましたか？',
      pp_home_sub:'コロラドの住宅/自動車保険について質問できます（一般情報）。見積や加入前に有資格者が確認します。',
      pp_start_chat:'チャットを開始',
      tab_home:'ホーム',
      tab_messages:'メッセージ',
      tab_settings:'設定',
      settings_title:'設定',
      settings_contact:'連絡先',
      settings_language:'言語',
      settings_disclaimer:'免責事項',
      settings_available:'利用可能',
      settings_open_disclaimer:'免責事項を開く',
      chat_placeholder:'雹の免責、山火事補償、バンドル…',
      chat_send:'送信',
      suggest_title:'よくある質問',
      suggest_home:'住宅保険',
      suggest_auto:'自動車保険',
      s_home_1:'雹や屋根の損害は補償される？',
      s_home_2:'風/雹の免責（％）って何？',
      s_home_3:'山火事/煙の補償で確認すべき点は？',
      s_auto_1:'雹被害は自動車保険で補償される？',
      s_auto_2:'包括（Comprehensive）と衝突（Collision）の違いは？',
      s_auto_3:'補償を落とさず保険料を下げる方法は？'
    },
    zh:{
      doc_title:'科罗拉多方案 — 房屋与汽车保险',
      meta_desc:'科罗拉多居民：了解更灵活的房屋与汽车保险方案，保护预算与安心。',
      hero_h1:'获取适合预算的房屋与汽车保险方案，守护重要资产。',
      hero_header_home:'房屋保险',
      hero_header_auto:'汽车保险',
      hero_header_business:'商业保险',
      cta_check:'查看我的选项',
      disclaimer_btn:'免责声明',
      chat_peek_label:'需要帮助？',
      chat_peek_name:'咨询 PolicyPro™',
      pp_home_title:'你好 — 我们能帮什么？',
      pp_home_sub:'可咨询科罗拉多房屋/汽车保险问题（仅一般信息）。报价/投保前由持牌代理复核。',
      pp_start_chat:'开始聊天',
      tab_home:'主页',
      tab_messages:'消息',
      tab_settings:'设置',
      settings_title:'设置',
      settings_contact:'联系',
      settings_language:'语言',
      settings_disclaimer:'免责声明',
      settings_available:'可用',
      settings_open_disclaimer:'打开免责声明',
      chat_placeholder:'询问冰雹免赔、野火保障、打包优惠…',
      chat_send:'发送',
      suggest_title:'常见问题',
      suggest_home:'房屋保险',
      suggest_auto:'汽车保险',
      s_home_1:'房屋保险是否涵盖冰雹与屋顶损失？',
      s_home_2:'什么是风/冰雹免赔额（%）？',
      s_home_3:'野火/烟雾保障应重点查看什么？',
      s_auto_1:'汽车保险是否涵盖冰雹损失？',
      s_auto_2:'综合险 vs 碰撞险分别保什么？',
      s_auto_3:'不降低保障的情况下如何降保费？'
    },
    fr:{
      doc_title:'Options Colorado — Assurance habitation & auto',
      meta_desc:'Résidents du Colorado : explorez des options flexibles d’assurance habitation et auto pour protéger votre budget et votre tranquillité.',
      hero_h1:"Obtenez des options habitation & auto flexibles, adaptées à votre budget et à ce qui compte.",
      hero_header_home:'Assurance habitation',
      hero_header_auto:'Assurance auto',
      hero_header_business:"Assurance entreprise",
      cta_check:'Voir mes options',
      disclaimer_btn:'Avertissement',
      chat_peek_label:'Besoin d’aide ?',
      chat_peek_name:'Discuter avec PolicyPro™',
      pp_home_title:'Bonjour — comment pouvons-nous aider ?',
      pp_home_sub:"Posez une question sur l’assurance habitation/auto au Colorado (info générale). Un agent agréé vérifie avant toute offre ou souscription.",
      pp_start_chat:'Démarrer le chat',
      tab_home:'Accueil',
      tab_messages:'Messages',
      tab_settings:'Réglages',
      settings_title:'Réglages',
      settings_contact:'Contact',
      settings_language:'Langue',
      settings_disclaimer:'Avertissement',
      settings_available:'Disponible',
      settings_open_disclaimer:"Ouvrir l’avertissement légal",
      chat_placeholder:'Grêle, incendies, franchises, regroupement…',
      chat_send:'Envoyer',
      suggest_title:'Questions fréquentes',
      suggest_home:'ASSURANCE HABITATION',
      suggest_auto:'ASSURANCE AUTO',
      s_home_1:'La grêle et le toit sont-ils couverts ?',
      s_home_2:'Qu’est-ce qu’une franchise vent/grêle (en %)?',
      s_home_3:'Que vérifier pour la couverture feu/fumée ?',
      s_auto_1:'La grêle est-elle couverte en assurance auto ?',
      s_auto_2:'Que couvre “comprehensive” vs “collision” ?',
      s_auto_3:'Comment baisser ma prime sans perdre de garanties ?'
    },
    ru:{
      doc_title:'Варианты в Колорадо — Дом и авто',
      meta_desc:'Жители Колорадо: гибкие варианты страхования дома и авто для защиты бюджета и спокойствия.',
      hero_h1:'Гибкие варианты страхования дома и авто под ваш бюджет — защитите важное.',
      hero_header_home:'Страхование дома',
      hero_header_auto:'Страхование авто',
      hero_header_business:'Страхование бизнеса',
      cta_check:'Проверить варианты',
      disclaimer_btn:'Дисклеймер',
      chat_peek_label:'Нужна помощь?',
      chat_peek_name:'Чат с PolicyPro™',
      pp_home_title:'Здравствуйте — чем помочь?',
      pp_home_sub:'Вопросы по страхованию дома/авто в Колорадо (общая информация). Перед любыми действиями проверит лицензированный агент.',
      pp_start_chat:'Начать чат',
      tab_home:'Домой',
      tab_messages:'Сообщения',
      tab_settings:'Настройки',
      settings_title:'Настройки',
      settings_contact:'Контакт',
      settings_language:'Язык',
      settings_disclaimer:'Дисклеймер',
      settings_available:'Доступно',
      settings_open_disclaimer:'Открыть дисклеймер',
      chat_placeholder:'Град, пожары, франшизы, пакет…',
      chat_send:'Отправить',
      suggest_title:'Популярные вопросы',
      suggest_home:'СТРАХОВАНИЕ ДОМА',
      suggest_auto:'СТРАХОВАНИЕ АВTO',
      s_home_1:'Покрывает ли страховка дома град и крышу?',
      s_home_2:'Что такое франшиза по ветру/граду (в %)?',
      s_home_3:'Что проверить по покрытию пожара/дыма?',
      s_auto_1:'Покрывается ли град автостраховкой?',
      s_auto_2:'Чем отличается comprehensive от collision?',
      s_auto_3:'Как снизить платеж без потери покрытия?'
    }
  };
}

  function getStrings_(lang){ var dict = i18nDict_(); return dict[lang] || dict.en; }
  function heroKeys_(){ return ['hero_header_home','hero_header_auto','hero_header_business']; }

  var __heroIndex = 0;
  function syncHeroHeader_(){
    var el = document.getElementById('heroHeader');
    if(!el) return;
    var reduce = false;
    try{ reduce = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches; }catch(e){ reduce = false; }
    var idx = reduce ? 0 : (__heroIndex % 3);

    var s = getStrings_(getLang_());
    var key = heroKeys_()[idx];
    el.textContent = s[key] || (idx === 0 ? 'Home Insurance' : (idx === 1 ? 'Car Insurance' : 'Business Insurance'));
  }

  function translatePage_(lang){
    var s = getStrings_(lang);

    try{ document.documentElement.lang = lang || 'en'; }catch(e){}
    try{ document.title = s.doc_title; }catch(e){}
    try{ var m = document.querySelector('meta[name="description"]'); if(m) m.setAttribute('content', s.meta_desc); }catch(e){}

    try{
      var nodes = document.querySelectorAll('[data-i18n]');
      for(var i=0;i<nodes.length;i++){
        var key = nodes[i].getAttribute('data-i18n');
        if(key && s[key]) nodes[i].innerHTML = String(s[key]);
      }
    }catch(e){}

    try{
      var ph = document.querySelectorAll('[data-i18n-placeholder]');
      for(var j=0;j<ph.length;j++){
        var k = ph[j].getAttribute('data-i18n-placeholder');
        if(k && s[k]) ph[j].setAttribute('placeholder', String(s[k]));
      }
    }catch(e){}

    try{ syncHeroHeader_(); }catch(e){}
  }

  function applyLanguage_(lang){
    lang = (lang || 'en');
    setLang_(lang);
    if(ppLangSelect) ppLangSelect.value = lang;
    translatePage_(lang);
  }

  (function(){
    var lang = getLang_();
    if(ppLangSelect){
      ppLangSelect.value = lang;
      ppLangSelect.addEventListener('change', function(){ applyLanguage_(ppLangSelect.value); });
    }
    applyLanguage_(lang);
  })();

  // =========================
  // Hero rotation (every 3s)
  // =========================
  function heroEls_(){
    return [
      document.getElementById('heroImg0'),
      document.getElementById('heroImg1'),
      document.getElementById('heroImg2')
    ];
  }

  function setActiveHero_(idx){
    var els = heroEls_();
    for(var i=0;i<els.length;i++) if(els[i]) els[i].classList.toggle('active', i === idx);
  }

  var HERO_SRCS = ['hero-house.png','hero-auto.png','hero-business.png'];
  function setHeroImgs_(srcs){
    var ids = ['heroImg0','heroImg1','heroImg2'];
    for(var i=0;i<ids.length;i++){
      var el = document.getElementById(ids[i]);
      if(el) el.src = srcs[i] || '';
    }

    // Update widget header image to match first hero (home)
    try{
      var top = document.querySelector('.pp-top');
      if(top && srcs[0]){
        top.style.background =
          "linear-gradient(180deg, rgba(2,6,23,0) 40%, rgba(2,6,23,.45) 100%), url('" + srcs[0] + "') center/cover no-repeat";
      }
    }catch(e){}
  }

  (function(){
    __heroIndex = 0;
    setActiveHero_(0);
    syncHeroHeader_();
    setHeroImgs_(HERO_SRCS);

    setInterval(function(){
      var reduce = false;
      try{ reduce = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches; }catch(e){ reduce = false; }
      if(reduce) return;

      __heroIndex = (__heroIndex + 1) % 3;
      setActiveHero_(__heroIndex);
      syncHeroHeader_();
    }, 3000);
  })();

  function esc_(s){
    s = String(s == null ? '' : s);
    return s.replace(/[&<>"']/g, function(c){
      return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c] || c;
    });
  }

  function addMsg_(role, html){
    if(!chatMessages) return;
    var wrap = document.createElement('div');
    wrap.className = 'msg ' + (role === 'user' ? 'user' : 'bot');

    var b = document.createElement('div');
    b.className = 'bubble ' + (role === 'user' ? 'user' : 'bot');
    b.innerHTML = html;

    wrap.appendChild(b);
    chatMessages.appendChild(wrap);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    saveChatState_();
  }

  function addTyping_(){
    addMsg_('bot', '<span class="typing" aria-label="PolicyPro is typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>');
  }

  function replaceLastBot_(html){
    if(!chatMessages) return;
    var items = chatMessages.querySelectorAll('.msg.bot .bubble');
    if(!items || !items.length) return;
    items[items.length-1].innerHTML = html;
    chatMessages.scrollTop = chatMessages.scrollHeight;
    saveChatState_();
  }

  function renderSuggestedQuestions_(){
    if(!chatMessages) return;
    if(chatMessages.childElementCount) return;
    if(chatHistory && chatHistory.length) return;

    var wrap = document.createElement('div');
    wrap.className = 'pp-suggest-wrap';

    var title = document.createElement('p');
    title.className = 'pp-suggest-title';
    title.textContent = getStrings_(getLang_()).suggest_title;

    var s = getStrings_(getLang_());
    var suggestionsHome = [s.s_home_1, s.s_home_2, s.s_home_3];
    var suggestionsAuto = [s.s_auto_1, s.s_auto_2, s.s_auto_3];

    function section_(label, items){
      var sec = document.createElement('div');
      sec.className = 'pp-suggest-section';

      var l = document.createElement('div');
      l.className = 'pp-suggest-label';
      l.textContent = label;

      var grid = document.createElement('div');
      grid.className = 'pp-suggest-grid';

      items.forEach(function(text){
        var b = document.createElement('button');
        b.type = 'button';
        b.className = 'pp-suggest-chip';
        b.textContent = text;
        b.addEventListener('click', function(){
          try{ wrap.remove(); }catch(e){}
          sendChat_(text);
        });
        grid.appendChild(b);
      });

      sec.appendChild(l);
      sec.appendChild(grid);
      return sec;
    }

    wrap.appendChild(title);
    wrap.appendChild(section_(s.suggest_home, suggestionsHome));
    wrap.appendChild(section_(s.suggest_auto, suggestionsAuto));

    chatMessages.appendChild(wrap);
  }

  function openChat_(){
    if(chatWindow) chatWindow.style.display = 'block';
    if(chatBtn) chatBtn.style.display = 'none';
    setTab_('home');
  }

  function closeChat_(){
    if(chatWindow) chatWindow.style.display = 'none';
    if(chatBtn) chatBtn.style.display = 'flex';
  }

  if(chatBtn) chatBtn.addEventListener('click', openChat_);
  if(closeChat) closeChat.addEventListener('click', closeChat_);

  if(ppTabHome) ppTabHome.addEventListener('click', function(){ setTab_('home'); });
  if(ppTabMessages) ppTabMessages.addEventListener('click', function(){ setTab_('messages'); });
  if(ppTabSettings) ppTabSettings.addEventListener('click', function(){ setTab_('settings'); });

  if(ppStartChat) ppStartChat.addEventListener('click', function(){
    setTab_('messages');
    setTimeout(function(){ renderSuggestedQuestions_(); }, 0);
  });

  // Link inside Settings to open disclaimer
  if(ppOpenDisclaimerLink){
    ppOpenDisclaimerLink.addEventListener('click', function(e){
      e.preventDefault();
      try{ showDisclaimer(); }catch(err){}
    });
  }

  // ===== Disclaimer modal (manual only; no auto popups) =====
  var openDisclaimer = document.getElementById('openDisclaimer');
  var discOverlay = document.getElementById('discOverlay');
  var discModal = document.getElementById('discModal');
  var discClose = document.getElementById('discClose');
  var discClose2 = document.getElementById('discClose2');
  var discAccept = document.getElementById('discAccept');

  function showDisclaimer(){ if(discOverlay) discOverlay.style.display = 'block'; if(discModal) discModal.style.display = 'flex'; }
  function hideDisclaimer(){ if(discOverlay) discOverlay.style.display = 'none'; if(discModal) discModal.style.display = 'none'; }
  function acceptDisclaimer_(){ try{ sessionStorage.setItem('sc_disclaimer_accepted_session','1'); }catch(e){} hideDisclaimer(); }

  if(openDisclaimer) openDisclaimer.addEventListener('click', showDisclaimer);
  if(discOverlay) discOverlay.addEventListener('click', hideDisclaimer);
  if(discClose) discClose.addEventListener('click', hideDisclaimer);
  if(discClose2) discClose2.addEventListener('click', hideDisclaimer);
  if(discAccept) discAccept.addEventListener('click', acceptDisclaimer_);

  // ===== Policy Health Check persistence (prefill across sessions) =====
  var PHC_STATE_KEY = 'sc_phc_state_v1';

  function readPHCState_(){
    try{ var raw = localStorage.getItem(PHC_STATE_KEY); return raw ? JSON.parse(raw) : null; }
    catch(e){ return null; }
  }

  function writePHCState_(state){
    try{ localStorage.setItem(PHC_STATE_KEY, JSON.stringify(state || {})); }catch(e){}
  }

  function getPHCStateFromDOM_(){
    return {
      changes: collectCheckedValues_('phcChanges'),
      property: (document.getElementById('phcProperty') ? document.getElementById('phcProperty').value : ''),
      deductible: (document.getElementById('phcDeductible') ? document.getElementById('phcDeductible').value : ''),
      liability: (document.getElementById('phcLiability') ? document.getElementById('phcLiability').value : ''),
      review: (document.getElementById('phcReview') ? document.getElementById('phcReview').value : ''),
      risks: collectCheckedValues_('phcRisks'),
      updatedAt: new Date().toISOString()
    };
  }

  function savePHCState_(){ writePHCState_(getPHCStateFromDOM_()); }

  function setCheckboxGroupFromValues_(containerId, values){
    try{
      var c = document.getElementById(containerId);
      if(!c) return;
      var v = Array.isArray(values) ? values : [];
      var boxes = c.querySelectorAll('input[type="checkbox"]');
      var noneOnly = v.indexOf('None') >= 0;
      for(var i=0;i<boxes.length;i++){
        var val = String(boxes[i].value || '').trim();
        boxes[i].checked = noneOnly ? (val === 'None') : (v.indexOf(val) >= 0);
        try{ boxes[i].dispatchEvent(new Event('change', { bubbles:true })); }catch(e){}
      }
    }catch(e){}
  }

  function setSelectValueIfExists_(selectId, value){
    try{
      var sel = document.getElementById(selectId);
      if(!sel) return;
      var v = String(value || '');
      if(!v) return;
      var opts = sel.querySelectorAll('option');
      var ok = false;
      for(var i=0;i<opts.length;i++){
        var ov = String(opts[i].value || '').trim();
        var ot = String(opts[i].textContent || '').trim();
        if(ov === v || ot === v){ ok = true; break; }
      }
      if(ok){ sel.value = v; try{ sel.dispatchEvent(new Event('change', { bubbles:true })); }catch(e){} }
    }catch(e){}
  }

  function hydratePHCFromSaved_(){
    var st = readPHCState_();
    if(!st) return;
    setCheckboxGroupFromValues_('phcChanges', st.changes);
    setSelectValueIfExists_('phcProperty', st.property);
    setSelectValueIfExists_('phcDeductible', st.deductible);
    setSelectValueIfExists_('phcLiability', st.liability);
    setSelectValueIfExists_('phcReview', st.review);
    setCheckboxGroupFromValues_('phcRisks', st.risks);
  }

  function bindPHCPersistListeners_(){
    function onAnyChange(){ try{ savePHCState_(); }catch(e){} }
    try{
      var ids = ['phcProperty','phcDeductible','phcLiability','phcReview'];
      for(var i=0;i<ids.length;i++){
        var el = document.getElementById(ids[i]);
        if(el) el.addEventListener('change', onAnyChange);
      }
      var groups = ['phcChanges','phcRisks'];
      for(var g=0;g<groups.length;g++){
        var c = document.getElementById(groups[g]);
        if(c) c.addEventListener('change', onAnyChange);
      }
    }catch(e){}
  }

  try{
    if(document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', function(){ bindPHCPersistListeners_(); hydratePHCFromSaved_(); });
    }else{
      bindPHCPersistListeners_();
      hydratePHCFromSaved_();
    }
  }catch(e){}

  // ===== Mobile-friendly Policy Health Check (tap-to-advance) =====
  function setupChipHighlights_(){
    try{
      var chips = document.querySelectorAll('.phc-chip');
      for(var i=0;i<chips.length;i++){
        (function(chip){
          var box = chip.querySelector('input[type="checkbox"]');
          if(!box) return;
          function sync(){ chip.classList.toggle('active', !!box.checked); }
          sync();
          chip.addEventListener('click', function(){ setTimeout(sync, 0); });
          box.addEventListener('change', sync);
        })(chips[i]);
      }
    }catch(e){}
  }

  function isMobilePHC_(){ return window.matchMedia && window.matchMedia('(max-width: 600px)').matches; }

  function clearActiveBtns_(wrap){
    try{
      var btns = wrap.querySelectorAll('.phc-answer-btn');
      for(var i=0;i<btns.length;i++) btns[i].classList.remove('active');
    }catch(e){}
  }

  function buildButtonsFromSelect_(selectId, targetId){
    var sel = document.getElementById(selectId);
    var target = document.getElementById(targetId);
    if(!sel || !target) return;

    target.innerHTML = '';

    var opts = sel.querySelectorAll('option');
    for(var i=0;i<opts.length;i++){
      var val = (opts[i].value || '').trim();
      var txt = (opts[i].textContent || '').trim();
      if(!txt || val === '') continue; // skip placeholder

      var b = document.createElement('button');
      b.type = 'button';
      b.className = 'phc-answer-btn';
      b.textContent = txt;
      b.setAttribute('data-value', txt);
      b.addEventListener('click', function(){
        var v = this.getAttribute('data-value') || '';
        try{ sel.value = v; }catch(e){}
        clearActiveBtns_(target);
        this.classList.add('active');
      });
      target.appendChild(b);
    }

    // Preselect if value already set
    try{
      if(sel.value){
        var btns = target.querySelectorAll('.phc-answer-btn');
        for(var j=0;j<btns.length;j++){
          if((btns[j].getAttribute('data-value')||'') === sel.value){
            btns[j].classList.add('active');
            break;
          }
        }
      }
    }catch(e){}
  }

  function buildButtonsFromCheckboxGroup_(containerId, targetId){
    var c = document.getElementById(containerId);
    var target = document.getElementById(targetId);
    if(!c || !target) return;

    target.innerHTML = '';
    var labels = c.querySelectorAll('label.phc-chip');

    for(var i=0;i<labels.length;i++){
      (function(lbl){
        var box = lbl.querySelector('input[type="checkbox"]');
        if(!box) return;
        var text = (lbl.textContent || '').trim();

        var b = document.createElement('button');
        b.type = 'button';
        b.className = 'phc-answer-btn';
        b.textContent = text;

        function sync(){ b.classList.toggle('active', !!box.checked); }
        sync();

        b.addEventListener('click', function(){
          // Special handling for None
          var v = String(box.value || '').trim();
          if(v === 'None'){
            // uncheck all others
            try{
              var others = c.querySelectorAll('input[type="checkbox"]');
              for(var k=0;k<others.length;k++) others[k].checked = false;
              box.checked = true;
            }catch(e){}
          }else{
            // if any non-None is checked, uncheck None
            try{
              var noneBox = c.querySelector('input[type="checkbox"][value="None"]');
              if(noneBox) noneBox.checked = false;
            }catch(e){}
            box.checked = !box.checked;
          }
          try{ box.dispatchEvent(new Event('change', { bubbles:true })); }catch(e){}
          sync();
        });

        // keep button in sync with underlying checkbox
        box.addEventListener('change', sync);

        target.appendChild(b);
      })(labels[i]);
    }
  }

  var __phcMobileStep = 0;
  var __phcMobileTotal = 6; // Q0..Q5

  function phcShow_(idx){
    __phcMobileStep = Math.max(0, Math.min(__phcMobileTotal, idx|0));
    for(var i=0;i<=__phcMobileTotal;i++){
      var el = document.getElementById(i === __phcMobileTotal ? 'phcQDone' : ('phcQ' + i));
      if(el) el.style.display = (i === __phcMobileStep) ? 'block' : 'none';
    }
  }

  function phcEnsureSelected_(selectId){
    var sel = document.getElementById(selectId);
    if(!sel) return true;
    return !!String(sel.value || '').trim();
  }

  function setupPhcMobileFlow_(){
    if(!isMobilePHC_()) return;

    // Build mobile answer buttons
    buildButtonsFromCheckboxGroup_('phcChanges', 'phcMobileChanges');
    buildButtonsFromSelect_('phcProperty', 'phcMobileProperty');
    buildButtonsFromSelect_('phcDeductible', 'phcMobileDeductible');
    buildButtonsFromSelect_('phcLiability', 'phcMobileLiability');
    buildButtonsFromSelect_('phcReview', 'phcMobileReview');
    buildButtonsFromCheckboxGroup_('phcRisks', 'phcMobileRisks');

    // Wire nav buttons + auto-advance on single-choice taps
    function bindAutoAdvance_(wrapId, nextFn){
      var w = document.getElementById(wrapId);
      if(!w) return;
      w.addEventListener('click', function(e){
        var t = e.target;
        if(!t || !t.classList || !t.classList.contains('phc-answer-btn')) return;
        // For single-choice groups, advance shortly after selection
        if(wrapId !== 'phcMobileChanges' && wrapId !== 'phcMobileRisks'){
          setTimeout(nextFn, 120);
        }
      });
    }

    var n0 = document.getElementById('phcNext0');
    var b1 = document.getElementById('phcBack1');
    var n1 = document.getElementById('phcNext1');
    var b2 = document.getElementById('phcBack2');
    var n2 = document.getElementById('phcNext2');
    var b3 = document.getElementById('phcBack3');
    var n3 = document.getElementById('phcNext3');
    var b4 = document.getElementById('phcBack4');
    var n4 = document.getElementById('phcNext4');
    var b5 = document.getElementById('phcBack5');
    var fin = document.getElementById('phcFinish');

    if(n0) n0.addEventListener('click', function(){ phcShow_(1); });

    if(b1) b1.addEventListener('click', function(){ phcShow_(0); });
    if(n1) n1.addEventListener('click', function(){
      if(!phcEnsureSelected_('phcProperty')){ try{ document.getElementById('phcProperty').reportValidity(); }catch(e){} return; }
      phcShow_(2);
    });

    if(b2) b2.addEventListener('click', function(){ phcShow_(1); });
    if(n2) n2.addEventListener('click', function(){
      if(!phcEnsureSelected_('phcDeductible')){ try{ document.getElementById('phcDeductible').reportValidity(); }catch(e){} return; }
      phcShow_(3);
    });

    if(b3) b3.addEventListener('click', function(){ phcShow_(2); });
    if(n3) n3.addEventListener('click', function(){
      if(!phcEnsureSelected_('phcLiability')){ try{ document.getElementById('phcLiability').reportValidity(); }catch(e){} return; }
      phcShow_(4);
    });

    if(b4) b4.addEventListener('click', function(){ phcShow_(3); });
    if(n4) n4.addEventListener('click', function(){
      if(!phcEnsureSelected_('phcReview')){ try{ document.getElementById('phcReview').reportValidity(); }catch(e){} return; }
      phcShow_(5);
    });

    if(b5) b5.addEventListener('click', function(){ phcShow_(4); });
    if(fin) fin.addEventListener('click', function(){
      phcShow_(__phcMobileTotal);
      // Render result immediately on mobile finish
      try{
        if(phcRequiredComplete_()){
          var res = computePHC_();
          renderPHCResult_(res.health, 'mobile');
        }
      }catch(e){}
    });

    bindAutoAdvance_('phcMobileProperty', function(){ if(n1) n1.click(); });
    bindAutoAdvance_('phcMobileDeductible', function(){ if(n2) n2.click(); });
    bindAutoAdvance_('phcMobileLiability', function(){ if(n3) n3.click(); });
    bindAutoAdvance_('phcMobileReview', function(){ if(n4) n4.click(); });

    phcShow_(0);
  }

  // Build mobile flow when modal is shown (ensures DOM exists)
  try{
    if(document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', function(){
        setupChipHighlights_();
      });
    }else{
      setupChipHighlights_();
    }
  }catch(e){}

  // Also (re)initialize when opening the funnel/health check
  function setupPHCOnOpen_(){
    // Prefill from saved state first
    try{ hydratePHCFromSaved_(); }catch(e){}

    // Then sync UI affordances
    try{ setupChipHighlights_(); }catch(e){}
    try{ setupPhcMobileFlow_(); }catch(e){}

    // Ensure mobile answer buttons reflect hydrated values
    try{
      if(isMobilePHC_()){
        buildButtonsFromCheckboxGroup_('phcChanges', 'phcMobileChanges');
        buildButtonsFromSelect_('phcProperty', 'phcMobileProperty');
        buildButtonsFromSelect_('phcDeductible', 'phcMobileDeductible');
        buildButtonsFromSelect_('phcLiability', 'phcMobileLiability');
        buildButtonsFromSelect_('phcReview', 'phcMobileReview');
        buildButtonsFromCheckboxGroup_('phcRisks', 'phcMobileRisks');
      }
    }catch(e){}
  }

  // Hook into existing modal open paths
  try{
    if(openFunnelBtn) openFunnelBtn.addEventListener('click', function(){ setTimeout(setupPHCOnOpen_, 0); });
    if(openHealthCheckBtn) openHealthCheckBtn.addEventListener('click', function(){ setTimeout(setupPHCOnOpen_, 0); });
  }catch(e){}

  // ===== Policy Health Check scoring =====
  function collectCheckedValues_(containerId){
    var out = [];
    try{
      var c = document.getElementById(containerId);
      if(!c) return out;
      var boxes = c.querySelectorAll('input[type="checkbox"]');
      for(var i=0;i<boxes.length;i++) if(boxes[i].checked) out.push(String(boxes[i].value || '').trim());
    }catch(e){}
    if(out.indexOf('None') >= 0) return ['None'];
    return out;
  }

  function policyHealthScore_(answers){
    answers = answers || {};
    var triggers = [];
    var score = 100;

    function has_(arr, v){ return Array.isArray(arr) && arr.indexOf(v) >= 0; }

    var changes = answers.changes || [];
    var risks = answers.risks || [];
    var property = String(answers.property || '');
    var deductible = String(answers.deductible || '');
    var liability = String(answers.liability || '');
    var review = String(answers.review || '');

    var unsureCount = 0;
    if(property === 'Not sure') unsureCount++;
    if(deductible === 'Not sure') unsureCount++;
    if(review === 'Not sure') unsureCount++;
    if(liability === 'Not protected / Not sure') unsureCount++;
    if(has_(changes,'None') === false && changes.length === 0) unsureCount++;
    if(has_(risks,'Not sure')) unsureCount++;

    if(unsureCount >= 2){ score -= 18; triggers.push('Multiple unknowns'); }

    var majorChange = false;
    var majorSet = ['Moved/bought home','New driver/teen driver','New vehicle/financed/leased','Marriage/divorce/new baby','Work from home/home business','Major remodel/new roof/solar'];
    for(var i=0;i<majorSet.length;i++) if(has_(changes, majorSet[i])){ majorChange = true; break; }
    if(majorChange){ score -= 14; triggers.push('Recent life change'); }

    if(review === '1–3 years ago') score -= 8;
    if(review === '3+ years ago / never'){ score -= 18; triggers.push('No recent policy review'); }
    if(review === 'Not sure'){ score -= 10; triggers.push('Review date unknown'); }

    if(liability === 'Somewhat protected'){ score -= 8; triggers.push('Liability may be low'); }
    if(liability === 'Not protected / Not sure'){ score -= 18; triggers.push('Liability likely insufficient'); }

    if(deductible === '$500–$1,000') score -= 6;
    if(deductible === 'Not sure'){ score -= 10; triggers.push('Deductible unknown'); }

    if(has_(risks,'Wildfire/brush nearby')){ score -= 6; triggers.push('Wildfire exposure'); }
    if(has_(risks,'Hail-prone / roof 10+ yrs')){ score -= 6; triggers.push('Hail/roof exposure'); }
    if(has_(risks,'Basement/sump pump')){ score -= 4; triggers.push('Water backup risk'); }
    if(has_(risks,'Pool/trampoline/dog')){ score -= 4; triggers.push('Higher liability exposure'); }

    if(score < 0) score = 0;
    if(score > 100) score = 100;

    var label = 'Green';
    if(score < 55) label = 'Red';
    else if(score < 80) label = 'Yellow';

    if((majorChange && (review === '3+ years ago / never' || review === 'Not sure')) || unsureCount >= 3){
      if(triggers.indexOf('High mismatch risk') < 0) triggers.push('High mismatch risk');
      label = 'Red';
    }

    return { score0to100: score, label: label, triggers: triggers };
  }

  function leadPriorityScore_(payloadLead, health){
    var score = 0;

    var tf = String(payloadLead.timeframe || '');
    if(tf === 'ASAP') score += 35;
    else if(tf === 'Within 7 days') score += 28;
    else if(tf === 'Within 30 days') score += 18;
    else if(tf === 'Just exploring') score += 8;

    if(payloadLead.zip) score += 6;
    if(payloadLead.phone) score += 6;
    if(payloadLead.email) score += 6;

    if(health && health.label === 'Red') score += 30;
    else if(health && health.label === 'Yellow') score += 18;
    else score += 10;

    try{ if(health && Array.isArray(health.triggers) && health.triggers.indexOf('Recent life change') >= 0) score += 6; }catch(e){}

    if(score > 100) score = 100;

    var label = 'COOL';
    if(score >= 70) label = 'HOT';
    else if(score >= 45) label = 'WARM';

    return { score: score, label: label };
  }

  // ===== PHC Result UI (Green / Yellow / Red) =====
  function triggerExplain_(t){
    var map = {
      'Multiple unknowns':'Several items are unknown — a quick review can prevent surprises.',
      'Recent life change':'Recent life changes often require updates (drivers, vehicles, address, usage, etc.).',
      'No recent policy review':'It’s been a while since a full review — coverage and discounts may be out of date.',
      'Review date unknown':'If you’re not sure when it was reviewed, it’s worth a quick check.',
      'Liability may be low':'Liability is often the most cost-effective protection to increase.',
      'Liability likely insufficient':'If liability is low/unknown, your risk exposure may be higher than expected.',
      'Deductible unknown':'Knowing your deductible helps avoid “surprise” out-of-pocket costs.',
      'Wildfire exposure':'Wildfire exposure can affect availability, deductibles, and endorsements.',
      'Hail/roof exposure':'Hail/roof items can affect deductibles and roof settlement/eligibility.',
      'Water backup risk':'Water backup is commonly excluded unless specifically added.',
      'Higher liability exposure':'Pools/trampolines/dogs can increase liability exposure.',
      'High mismatch risk':'Multiple signals suggest your policy may not match your current life/property.'
    };
    return map[t] || t;
  }

  function resultCopy_(label){
    if(label === 'Green') return 'Likely on-track. Still, a quick review can confirm deductibles, liability, and endorsements match your current life.';
    if(label === 'Yellow') return 'A few things may be worth tightening. A 5-minute agent review can spot gaps and find better-fit options.';
    return 'High mismatch risk. Based on your answers, your coverage may not reflect your current life/property — an agent review is recommended.';
  }

  function phcCtaText_(label, lang){
    var s = getStrings_(lang || getLang_());
    if(label === 'Yellow') return s.phc_cta_yellow || 'Fix Potential Gaps';
    if(label === 'Red') return s.phc_cta_red || 'Review My Policy Now';
    return s.phc_cta_green || 'Confirm My Coverage';
  }

  function renderPHCResult_(health, where){
    where = where || 'desktop';

    var root = document.getElementById(where === 'mobile' ? 'phcResultMobile' : 'phcResult');
    var dot = document.getElementById(where === 'mobile' ? 'phcDotMobile' : 'phcDot');
    var lab = document.getElementById(where === 'mobile' ? 'phcLabelMobile' : 'phcLabel');
    var copy = document.getElementById(where === 'mobile' ? 'phcCopyMobile' : 'phcCopy');
    var why = document.getElementById(where === 'mobile' ? 'phcWhyMobile' : 'phcWhy');
    var cta = document.getElementById(where === 'mobile' ? 'phcCtaMobile' : 'phcCta');
    var summary = document.getElementById(where === 'mobile' ? 'phcSummaryMobile' : 'phcSummary');

    if(!root || !dot || !lab || !copy || !why) return;

    dot.className = 'phc-dot' + (health.label === 'Yellow' ? ' yellow' : (health.label === 'Red' ? ' red' : ''));
    lab.textContent = health.label;
    copy.textContent = resultCopy_(health.label);

    why.innerHTML = '';
    var triggers = Array.isArray(health.triggers) ? health.triggers.slice(0, 3) : [];
    if(!triggers.length) triggers = ['General review recommended'];

    for(var i=0;i<triggers.length;i++){
      var li = document.createElement('li');
      li.textContent = triggerExplain_(triggers[i]);
      why.appendChild(li);
    }

    // Micro-summary above CTA
    try{
      if(summary){
        var s2 = getStrings_(getLang_());
        summary.textContent = (s2 && s2.phc_based_on) ? s2.phc_based_on : 'Based on what you shared…';
        summary.style.display = 'block';
      }
    }catch(e){}

    // Result-based CTA copy
    if(cta){
      cta.textContent = phcCtaText_(health.label, getLang_());
      cta.style.display = 'inline-flex';
    }

    root.classList.add('show');
  }

  function computePHC_(){

    var phc = {
      changes: collectCheckedValues_('phcChanges'),
      property: (document.getElementById('phcProperty') ? document.getElementById('phcProperty').value : ''),
      deductible: (document.getElementById('phcDeductible') ? document.getElementById('phcDeductible').value : ''),
      liability: (document.getElementById('phcLiability') ? document.getElementById('phcLiability').value : ''),
      review: (document.getElementById('phcReview') ? document.getElementById('phcReview').value : ''),
      risks: collectCheckedValues_('phcRisks')
    };
    return { phc: phc, health: policyHealthScore_(phc) };
  }

  function phcRequiredComplete_(){
    try{
      var p = document.getElementById('phcProperty');
      var d = document.getElementById('phcDeductible');
      var l = document.getElementById('phcLiability');
      var r = document.getElementById('phcReview');
      return !!(p && p.value && d && d.value && l && l.value && r && r.value);
    }catch(e){ return false; }
  }

  function bindPHCResultUI_(){
    var runBtn = document.getElementById('phcRun');
    var ctaDesk = document.getElementById('phcCta');
    var ctaMob = document.getElementById('phcCtaMobile');

    function runDesk(){
      if(!phcRequiredComplete_()){
        try{
          var p = document.getElementById('phcProperty');
          var d = document.getElementById('phcDeductible');
          var l = document.getElementById('phcLiability');
          var r = document.getElementById('phcReview');
          if(p && !p.value) p.reportValidity();
          else if(d && !d.value) d.reportValidity();
          else if(l && !l.value) l.reportValidity();
          else if(r && !r.value) r.reportValidity();
        }catch(e){}
        return;
      }
      var res = computePHC_();
      renderPHCResult_(res.health, 'desktop');
    }

    if(runBtn) runBtn.addEventListener('click', runDesk);

    function goOptions_(){
      try{
        if(isMobile_()) setStep_(3);
        else{
          var consent = document.getElementById('consent');
          if(consent) consent.scrollIntoView({ behavior:'smooth', block:'start' });
        }
      }catch(e){}
    }

    if(ctaDesk) ctaDesk.addEventListener('click', goOptions_);
    if(ctaMob) ctaMob.addEventListener('click', goOptions_);
  }

  try{ bindPHCResultUI_(); }catch(e){}

  // ===== Lead form submit =====
  if(leadForm){
    leadForm.addEventListener('submit', function(e){
      e.preventDefault();
      if(formStatus){ formStatus.style.display='block'; formStatus.className='status'; }

      if(!GAS || GAS.indexOf('http') !== 0){
        if(formStatus){
          formStatus.className='status err';
          formStatus.textContent='Backend not connected yet. Paste your Apps Script Web App URL into window.GAS_WEBAPP_URL at the top of this file.';
        }
        return;
      }

      var payloadLead = {
        action: 'lead',
        source: 'GitHub Landing Page',
        channel: 'CTA Funnel',
        timestamp: new Date().toISOString(),
        firstName: (document.getElementById('firstName').value || '').trim(),
        lastName: (document.getElementById('lastName').value || '').trim(),
        zip: (document.getElementById('zip').value || '').trim(),
        email: (document.getElementById('email').value || '').trim(),
        phone: (document.getElementById('phone').value || '').trim(),
        homeowner: (document.getElementById('homeowner').value || ''),
        roofAge: (document.getElementById('roofAge').value || ''),
        vehicles: (document.getElementById('vehicles').value || ''),
        timeframe: (document.getElementById('timeframe').value || ''),
        notes: (document.getElementById('notes').value || '').trim(),
        consent: true,
        aiConsent: true,
        deliverKit: true,
        kitType: 'FIRE_HAIL_ENDORSEMENTS'
      };

      var phc = {
        changes: collectCheckedValues_('phcChanges'),
        property: (document.getElementById('phcProperty') ? document.getElementById('phcProperty').value : ''),
        deductible: (document.getElementById('phcDeductible') ? document.getElementById('phcDeductible').value : ''),
        liability: (document.getElementById('phcLiability') ? document.getElementById('phcLiability').value : ''),
        review: (document.getElementById('phcReview') ? document.getElementById('phcReview').value : ''),
        risks: collectCheckedValues_('phcRisks')
      };

      var health = policyHealthScore_(phc);
      payloadLead.policyHealthScore = health.score0to100;
      payloadLead.policyHealthLabel = health.label;
      payloadLead.policyHealthTriggers = (health.triggers || []).join(' | ');
      payloadLead.policyHealthAnswers = phc;
      // Store the exact result-based CTA copy shown to the user (useful for analytics + Sheets)
      payloadLead.policyHealthCtaText = phcCtaText_(health.label, getLang_());

      var priority = leadPriorityScore_(payloadLead, health);
      payloadLead.leadScore = priority.score;
      payloadLead.leadLabel = priority.label;

      if(formStatus) formStatus.textContent='Submitting…';

      postToGAS(GAS, payloadLead).then(function(){
        if(formStatus){
          formStatus.className='status ok';
          formStatus.textContent='✅ Submitted! Check your email for your coverage guide.';
        }
        leadForm.reset();
        setTimeout(hideModal, 900);
        try{ resetStepper_(); }catch(e){}
      }).catch(function(err){
        if(formStatus){
          formStatus.className='status err';
          formStatus.textContent='⚠ Could not submit (network error). Double-check the Apps Script URL and that it is deployed as a Web App. (' + (err && err.message ? err.message : 'Error') + ')';
        }
      });
    });
  }

  // ===== Basic chat send (LOCAL mode gives safe canned response; REMOTE can use your endpoint later) =====
  var POLICYPRO_MODE = ((window.POLICYPRO_MODE || '') + '').trim().toLowerCase() || 'local';
  var CHAT_ENDPOINT = (POLICYPRO_MODE === 'remote')
    ? (((window.POLICYPRO_LLM_ENDPOINT || '').trim() || (window.GAS_WEBAPP_URL || '').trim()))
    : '';

  function localAnswer_(q){
    var t = String(q||'').toLowerCase();
    if(t.indexOf('hail')>=0 || t.indexOf('roof')>=0) return 'Generally, hail damage can be covered depending on your policy type, deductibles (often a wind/hail deductible), and roof condition. An agent should review your declarations page and endorsements to confirm.';
    if(t.indexOf('wildfire')>=0 || t.indexOf('smoke')>=0) return 'Wildfire/smoke impacts are very policy-specific. Common items to review: dwelling limit, additional living expense (ALE), debris removal, smoke damage, and any wildfire-specific exclusions/endorsements. An agent review is recommended.';
    if(t.indexOf('auto')>=0 || t.indexOf('comprehensive')>=0) return 'Auto hail is typically under comprehensive coverage (not collision). Deductibles and repair method can affect outcomes. An agent can confirm what your policy includes.';
    return 'I can share general insurance info, but a licensed agent must confirm anything policy-specific. If you want, tap “Check My Options” so an agent can follow up with personalized options.';
  }

  function sendChat_(text){
    text = String(text||'').trim();
    if(!text) return;

    addMsg_('user', esc_(text));
    addTyping_();

    if(POLICYPRO_MODE !== 'remote'){
      setTimeout(function(){
        replaceLastBot_(esc_(localAnswer_(text)));
      }, 550);
      return;
    }

    // Remote mode (optional): post question to your endpoint
    fetch(CHAT_ENDPOINT, {
      method:'POST',
      mode:'no-cors',
      headers:{'Content-Type':'text/plain;charset=utf-8'},
      body: JSON.stringify({ action:'chat', message:text, lang:getLang_(), history:chatHistory.slice(-20) })
    }).then(function(){
      // Opaque in no-cors; show a friendly fallback
      setTimeout(function(){
        replaceLastBot_(esc_('Thanks — an agent will follow up shortly. If you want faster help, tap “Check My Options”.'));
      }, 600);
    }).catch(function(){
      replaceLastBot_(esc_(localAnswer_(text)));
    });
  }

  if(chatForm){
    chatForm.addEventListener('submit', function(e){
      e.preventDefault();
      var v = (chatInput && chatInput.value) ? chatInput.value : '';
      if(chatInput) chatInput.value = '';
      sendChat_(v);
    });
  }

  // =========================
  // Minimal self-tests (run only when ?test=1 is present)
  // =========================
  function __assert_(cond, msg){ if(!cond) throw new Error('Test failed: ' + (msg || '')); }
  function runTests_(){
  __assert_(typeof setTab_ === 'function', 'setTab_ exists');

  // i18n sanity
  var dict = i18nDict_();
  __assert_(dict && dict.en && dict.es, 'i18n has en + es');
  __assert_(typeof getStrings_('en').cta_check === 'string', 'en strings resolve');
  __assert_(typeof getStrings_('es').cta_check === 'string', 'es strings resolve');

  // tab switching
  setTab_('home');
  __assert_(ppScreenHome ? ppScreenHome.classList.contains('active') : true, 'home screen active');
  setTab_('messages');
  __assert_(ppScreenMessages ? ppScreenMessages.classList.contains('active') : true, 'messages screen active');
  setTab_('settings');
  __assert_(ppScreenSettings ? ppScreenSettings.classList.contains('active') : true, 'settings screen active');

  // Invalid values should not throw
  setTab_('nope');
}

  try{ if((location.search || '').indexOf('test=1') >= 0) runTests_(); }catch(e){ console.error(e); }
</script>

</body>
</html>
